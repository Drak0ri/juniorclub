<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Club Attendance</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700;800&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:"Open Sans",system-ui;
  background:radial-gradient(circle at top,#0b1020,#000);
  color:#eef4ff;
  text-align:center;
}
header{
  display:flex;
  align-items:center;
  gap:14px;
  padding:14px 18px;
  background:rgba(16,45,105,.28);
  border-bottom:1px solid rgba(255,255,255,.12);
}
.logo{width:42px;height:42px}
main{padding:24px;max-width:900px;margin:auto}
button,input{
  font-size:18px;
  padding:14px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.25);
  background:rgba(255,255,255,.08);
  color:#eef4ff;
}
button{cursor:pointer;font-weight:800}
button.active{outline:3px solid #00a0df}
.panel{
  margin-top:20px;
  padding:18px;
  border-radius:20px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.18);
}
.hidden{display:none}
.big{font-size:72px;font-weight:900;margin:20px 0}
.ok{background:#0f3d1f}
.warn{background:#5c4a00}
#overlay{
  position:fixed;
  inset:0;
  display:none;
  place-items:center;
  color:white;
  z-index:50;
}
</style>
</head>
<body>

<input id="scanInput" autocomplete="off" style="position:absolute;left:-9999px">
<iframe name="hidden_iframe" style="display:none"></iframe>

<header>
  <img src="./logo-primary.png" class="logo"
       onerror="this.onerror=null;this.src='./logo-negative.png'">
  <div>
    <strong>Internationella Engelska Skolan</strong><br>
    Club Attendance
  </div>
</header>

<main>
  <h1>Select session</h1>

  <button id="btnBreakfast">Breakfast Club</button>
  <button id="btnJunior">Junior Club</button>

  <div class="panel">
    <h1>Scan your card</h1>
    <p>No need to click â€” just scan</p>
    <button onclick="togglePin()">Staff: PIN entry</button>
  </div>

  <!-- PIN -->
  <div id="pinPanel" class="panel hidden">
    <h1>PIN entry</h1>
    <input id="pinInput" placeholder="4-digit PIN">
    <button onclick="submitPIN()">Submit PIN</button>
    <button onclick="closeStaffPanels()">Cancel</button>
  </div>

  <!-- REGISTER -->
  <div id="regPanel" class="panel hidden">
    <h1>Register new card</h1>
    <input id="regUid" readonly>
    <input id="regName" placeholder="Student name">
    <input id="regClass" placeholder="Class">
    <input id="regPin" placeholder="4-digit PIN">
    <button onclick="registerCard()">Register card</button>
    <button onclick="closeStaffPanels()">Cancel</button>
  </div>
</main>

<div id="overlay">
  <div class="big" id="overlayText"></div>
</div>

<script>
/* ================= CONFIG ================= */

const LIVE_UID_ALLOWLIST =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8mP6s7VAmjA-kJN2n9oFhd9kak5nZyakSKnEdckLBDW9mgdlycXMaIKjXPXG8Agma6li0ZmN9ZHcj/pub?gid=519609097&single=true&output=csv";

const FORM_A =
"https://docs.google.com/forms/d/e/1FAIpQLSf-SLyYYCL8FsW4Md8yEA54ET6U-egFa2Nc3a0_wwOl5qx2lA/formResponse";

const FORM_B =
"https://docs.google.com/forms/d/e/1FAIpQLSdg9PcY7JeBhq6DmTYFlsaRvvoskJ5HSzLOKTi5LZglHWmpMQ/formResponse";

const A = {
  type:"entry.277093114",
  value:"entry.241623352",
  session:"entry.1305410599",
  direction:"entry.729127686",
  station:"entry.1543290454",
  note:"entry.1332803006"
};

const B = {
  uid:"entry.383658627",
  pin:"entry.1137422341",
  name:"entry.2068849833",
  class:"entry.1002543871",
  note:"entry.205747186",
  by:"entry.2021702095"
};

const LOCKOUT_MS = 2500;

/* ================= STATE ================= */

let session="";
let lastScan="";
let lastScanAt=0;
let allowlist=new Set();
let scanMode=true;

/* ================= INIT ================= */

fetch(LIVE_UID_ALLOWLIST)
  .then(r=>r.text())
  .then(t=>{
    t.split(/\r?\n/).slice(1).forEach(v=>{
      if(v.trim()) allowlist.add(v.trim());
    });
  });

setInterval(()=>{
  if(scanMode) scanInput.focus();
},1000);

/* ================= UI ================= */

btnBreakfast.onclick=()=>selectSession("Breakfast Club");
btnJunior.onclick=()=>selectSession("Junior Club");

function selectSession(s){
  session=s;
  btnBreakfast.classList.toggle("active",s==="Breakfast Club");
  btnJunior.classList.toggle("active",s==="Junior Club");
}

function showOverlay(txt,cls){
  overlayText.textContent=txt;
  overlay.className=cls;
  overlay.style.display="grid";
  setTimeout(()=>overlay.style.display="none",1500);
}

function togglePin(){
  pinPanel.classList.toggle("hidden");
  scanMode=pinPanel.classList.contains("hidden");
}

function closeStaffPanels(){
  pinPanel.classList.add("hidden");
  regPanel.classList.add("hidden");
  scanMode=true;
}

/* ================= SCAN ================= */

scanInput.addEventListener("keydown",e=>{
  if(e.key==="Enter" && scanMode){
    handleScan(scanInput.value.trim());
    scanInput.value="";
  }
});

function handleScan(uid){
  if(!session){
    showOverlay("SELECT SESSION","warn"); return;
  }
  const now=Date.now();
  if(uid===lastScan && now-lastScanAt<LOCKOUT_MS){
    showOverlay("PLEASE WAIT","warn"); return;
  }
  lastScan=uid; lastScanAt=now;

  if(!allowlist.has(uid)){
    regPanel.classList.remove("hidden");
    scanMode=false;
    regUid.value=uid;
    regName.focus();
    showOverlay("UNKNOWN CARD","warn");
    return;
  }
  submitEvent("RFID",uid);
}

/* ================= SUBMIT ================= */

function post(url,data){
  const f=document.createElement("form");
  f.method="POST";f.action=url;f.target="hidden_iframe";
  Object.entries(data).forEach(([k,v])=>{
    const i=document.createElement("input");
    i.type="hidden";i.name=k;i.value=v;
    f.appendChild(i);
  });
  document.body.appendChild(f);
  f.submit();f.remove();
}

function submitEvent(type,value){
  post(FORM_A,{
    [A.type]:type,
    [A.value]:value,
    [A.session]:session,
    [A.direction]:"IN",
    [A.station]:"Student-Station",
    [A.note]:""
  });
  showOverlay("RECORDED","ok");
}

function submitPIN(){
  post(FORM_A,{
    [A.type]:"PIN",
    [A.value]:pinInput.value,
    [A.session]:session,
    [A.direction]:"IN",
    [A.station]:"Staff",
    [A.note]:"PIN entry"
  });
  pinInput.value="";
  closeStaffPanels();
  showOverlay("PIN OK","ok");
}

function registerCard(){
  post(FORM_B,{
    [B.uid]:regUid.value,
    [B.pin]:regPin.value,
    [B.name]:regName.value,
    [B.class]:regClass.value,
    [B.note]:"Registered at station",
    [B.by]:"Staff"
  });
  allowlist.add(regUid.value);
  closeStaffPanels();
  showOverlay("REGISTERED","ok");
}
</script>
</body>
</html>
