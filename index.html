<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Junior Club Attendance</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@700;800&display=swap" rel="stylesheet">

<style>
:root{
  --navy:#102d69; --white:#fff; --green:#d9e6b1; --blue:#bce4fa;
  --yellow:#fff7b2; --error:#b00020; --dark:#102d69;
}
*{ box-sizing:border-box; }
body{
  margin:0; height:100vh; background:var(--navy); color:var(--white);
  font-family:"Open Sans",Arial,sans-serif;
  display:grid; grid-template-rows:auto 1fr auto;
}
header{ display:flex; justify-content:space-between; align-items:center; padding:18px 22px; }
header img{ height:40px; }
.clock{ font-weight:800; font-size:20px; }
main{ display:grid; place-items:center; padding:20px; }
.card{
  width:min(900px,96vw); padding:clamp(26px,4vw,48px);
  border-radius:16px; text-align:center;
  background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.2);
}
.pill{
  display:inline-block; padding:8px 14px; border-radius:999px;
  font-weight:800; font-size:12px; letter-spacing:.8px; margin-bottom:18px;
  border:1px solid rgba(255,255,255,0.3); text-transform:uppercase;
}
.status{ font-size:clamp(64px,9vw,110px); font-weight:800; margin:0 0 10px; line-height:1; }
.sub{ font-size:16px; font-weight:700; opacity:.85; }
footer{ padding:14px 22px; font-size:12px; opacity:.75; display:flex; justify-content:space-between; }
.banner{
  position:fixed; left:12px; right:12px; bottom:12px;
  background:rgba(176,0,32,.92); color:#fff; padding:10px 12px;
  border-radius:12px; display:none; font-size:13px; font-weight:800;
}

body.in .card{ background:var(--green); color:var(--dark); }
body.out .card{ background:var(--blue); color:var(--dark); }
body.unknown .card{ background:var(--yellow); color:var(--dark); }
body.unknown .status{ color:var(--error); }
</style>
</head>

<body class="waiting">
<header>
  <img src="./ies-logo-white.png" alt="IES Logo">
  <div class="clock" id="clock">--:--</div>
</header>

<main>
  <div class="card">
    <div class="pill" id="pill">Loading…</div>
    <h1 class="status" id="status">READY</h1>
    <div class="sub" id="message">Hold card near the reader</div>
  </div>
</main>

<footer>
  <div>Junior Club Attendance</div>
  <div>V3.2</div>
</footer>

<div id="banner" class="banner"></div>

<script>
/* ===================== CONFIG (FROZEN) ===================== */
const ATT_FORM_URL =
  "https://docs.google.com/forms/d/e/1FAIpQLSf5zEJQa4T8tRgKOQ2DQ80OqCkrElNcx5X_5Udg0GJ4vyvpRQ/formResponse";

const ATT = {
  card_uid:       "entry.1104238975",
  event:          "entry.1735508359",
  device_id:      "entry.452811867",
  method:         "entry.1237226768",
  operator:       "entry.1642343573",
  note:           "entry.1538254700",
  club_id:        "entry.164839595",
  schema_version: "entry.2138280654"
};

const MAPPING_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=348834218&single=true&output=csv";

const ATT_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=1075501813&single=true&output=csv";

const DEVICE_ID = "Door-1";
const CLUB_ID = "IESV_JuniorClub";
const SCHEMA_VERSION = "v3";

const DEBOUNCE_MS = 5000;
const RESET_MS = 2500;
/* ============================================================ */

let knownActiveCards = new Set();
let mappingLoaded = false;
let stateByCard = {}; // card_uid -> "IN" | "OUT"

let buffer = "";
let lastKeyTime = 0;
let lastScan = { card:null, time:0 };

const banner = document.getElementById("banner");

function showBanner(msg){
  banner.textContent = msg;
  banner.style.display = "block";
  setTimeout(()=> banner.style.display="none", 5000);
}

function updateClock(){
  document.getElementById("clock").textContent =
    new Date().toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
}
setInterval(updateClock,1000); updateClock();

function setPill(t){ pill.textContent = t; }
function setStatus(t){ status.textContent = t; }
function setMsg(t){ message.textContent = t; }

function resetUI(){
  document.body.className = "waiting";
  setPill(mappingLoaded ? "Ready" : "Loading…");
  setStatus("READY");
  setMsg(mappingLoaded ? "Hold card near the reader" : "Loading student mapping…");
}

function showState(state, msg){
  document.body.className = state;
  setPill("Logged");
  setStatus(state.toUpperCase());
  setMsg(msg);
}

function splitCSVLine(line){
  const out=[]; let cur=""; let q=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c==='"'){
      if(q && line[i+1]==='"'){ cur+='"'; i++; }
      else q=!q;
    } else if(c===',' && !q){
      out.push(cur); cur="";
    } else cur+=c;
  }
  out.push(cur);
  return out.map(s=>s.trim());
}

function parseCSV(text){
  const lines = text.trim().split("\n");
  const headers = splitCSVLine(lines[0]);
  const rows = [];
  for(const l of lines.slice(1)){
    if(!l.trim()) continue;
    const vals = splitCSVLine(l);
    const obj = {};
    headers.forEach((h,i)=> obj[h] = (vals[i] || "").trim());
    rows.push(obj);
  }
  return rows;
}

/* EU timestamp parser */
function parseEU(ts){
  const m = ts && ts.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4}) (\d{1,2}):(\d{2}):(\d{2})$/);
  if(!m) return 0;
  return new Date(+m[3], m[2]-1, +m[1], +m[4], +m[5], +m[6]).getTime();
}

async function loadMapping(){
  try{
    const csv = await fetch(MAPPING_CSV_URL,{cache:"no-store"}).then(r=>r.text());
    const rows = parseCSV(csv);
    const latest={};
    for(const r of rows){
      if(!r.card_uid) continue;
      latest[r.card_uid]=r;
    }
    knownActiveCards = new Set(
      Object.values(latest)
        .filter(r=>(r.status||"").toLowerCase()==="active")
        .map(r=>r.card_uid)
    );
    mappingLoaded = true;
    resetUI();
  }catch{
    showBanner("Mapping load failed");
  }
}

async function loadLatestInOutState(){
  try{
    const csv = await fetch(ATT_CSV_URL,{cache:"no-store"}).then(r=>r.text());
    const rows = parseCSV(csv);
    const latest={};
    for(const r of rows){
      if(!r.card_uid) continue;
      const ev = (r.event||"").toUpperCase();
      if(ev!=="IN" && ev!=="OUT") continue;
      const t = parseEU(r.Timestamp);
      if(!latest[r.card_uid] || t > latest[r.card_uid].t){
        latest[r.card_uid]={ event:ev, t };
      }
    }
    stateByCard = Object.fromEntries(
      Object.entries(latest).map(([k,v])=>[k,v.event])
    );
  }catch{
    showBanner("Attendance preload failed");
  }
}

function postAttendance({ card_uid, event }){
  const d = new URLSearchParams();
  d.append(ATT.card_uid, card_uid);
  d.append(ATT.event, event);
  d.append(ATT.device_id, DEVICE_ID);
  d.append(ATT.method, "RFID");
  d.append(ATT.operator, "");
  d.append(ATT.note, "");
  d.append(ATT.club_id, CLUB_ID);
  d.append(ATT.schema_version, SCHEMA_VERSION);
  fetch(ATT_FORM_URL,{method:"POST",mode:"no-cors",body:d});
}

document.addEventListener("keydown",(e)=>{
  const now=Date.now();
  if(e.key.length===1){
    if(now-lastKeyTime>80) buffer="";
    buffer+=e.key; lastKeyTime=now; return;
  }
  if(e.key==="Enter"){
    const card=buffer.trim(); buffer="";
    if(!card||!mappingLoaded) return;
    if(lastScan.card===card && now-lastScan.time<DEBOUNCE_MS) return;
    lastScan={card,time:now};

    if(!knownActiveCards.has(card)){
      postAttendance({card_uid:card,event:"UNKNOWN"});
      document.body.className="unknown";
      setPill("Attention"); setStatus("UNKNOWN");
      setMsg("Unknown card — see staff");
      return setTimeout(resetUI,RESET_MS);
    }

    const prev = stateByCard[card] || "OUT";
    const next = prev==="IN" ? "OUT" : "IN";
    stateByCard[card]=next;

    postAttendance({card_uid:card,event:next});
    showState(next.toLowerCase(), next==="IN"?"You may enter":"You may leave");
    setTimeout(resetUI,RESET_MS);
  }
});

resetUI();
loadMapping();
loadLatestInOutState();
</script>
</body>
</html>
