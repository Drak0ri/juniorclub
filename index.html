<!-- /index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Junior Club Portal</title>

<link rel="icon" href="./ies.ico" type="image/x-icon">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@700;800&display=swap" rel="stylesheet">

<style>
/* ================= DESIGN v1 ================= */
:root{
--navy:#102d69;
--green-bg:#d9f2c7;
--green-text:#0b6b2f;
--red-bg:#ffd6d6;
--red-text:#b00020;
--yellow-bg:#fff3b0;
--dark:#102d69;
--white:#ffffff;
}

*{ box-sizing:border-box; }

body{
margin:0;
height:100vh;
background:var(--navy);
font-family:"Open Sans",Arial,sans-serif;
display:grid;
grid-template-rows:auto 1fr auto;
transition:background .25s ease;
}

/* ---------- HEADER ---------- */
header{
display:flex;
justify-content:space-between;
align-items:center;
padding:18px 22px;
color:#fff;
}
header img{ height:40px; }
.clock{ font-weight:800; font-size:20px; }

/* ---------- MAIN CARD ---------- */
main{
display:grid;
place-items:center;
padding:20px;
}

.card{
width:min(900px,96vw);
padding:clamp(32px,4vw,56px);
border-radius:22px;
text-align:center;
background:rgba(255,255,255,0.08);
border:1px solid rgba(255,255,255,0.25);
box-shadow:0 20px 60px rgba(0,0,0,.25);
transition:
background .25s ease,
transform .2s ease,
box-shadow .2s ease;
}

.pill{
display:inline-block;
padding:8px 18px;
border-radius:999px;
font-weight:800;
font-size:12px;
letter-spacing:.8px;
margin-bottom:22px;
text-transform:uppercase;
background:rgba(255,255,255,0.15);
color:#fff;
}

.status{
font-size:clamp(64px,9vw,110px);
font-weight:800;
margin:0 0 12px;
line-height:1;
}

.sub{
font-size:18px;
font-weight:700;
opacity:.9;
}

/* ---------- FOOTER ---------- */
footer{
padding:14px 22px;
font-size:12px;
opacity:.75;
display:flex;
justify-content:space-between;
color:#fff;
}

/* ---------- STATES ---------- */
body.ready .card{
animation:idlePulse 3s ease-in-out infinite;
}

@keyframes idlePulse{
0%,100%{ box-shadow:0 20px 60px rgba(0,0,0,.25); }
50%{ box-shadow:0 20px 80px rgba(255,255,255,.15); }
}

body.in .card{
background:var(--green-bg);
color:var(--dark);
transform:scale(1.02);
}
body.in .status{ color:var(--green-text); }

body.out .card{
background:var(--red-bg);
color:var(--dark);
}
body.out .status{ color:var(--red-text); }

body.unknown .card{
background:var(--yellow-bg);
color:var(--dark);
}
body.unknown .status{ color:var(--red-text); }

/* ---------- REGISTER BUTTON ---------- */
.register-btn{
margin-top:16px;
padding:14px 28px;
border:none;
border-radius:12px;
background:var(--navy);
color:#fff;
font-family:inherit;
font-size:18px;
font-weight:800;
cursor:pointer;
transition:transform .15s ease, background .15s ease;
}
.register-btn:hover{
background:#1a3d7a;
transform:translateY(-2px);
}

/* ---------- MODAL ---------- */
.modal-overlay{
position:fixed;
inset:0;
background:rgba(0,0,0,0.75);
display:none;
align-items:center;
justify-content:center;
padding:20px;
z-index:9999;
}
.modal-overlay.show{ display:flex; }

.modal{
background:var(--navy);
border:1px solid rgba(255,255,255,0.25);
border-radius:18px;
width:min(480px, 95vw);
overflow:hidden;
}

.modal-header{
background:rgba(255,255,255,0.08);
padding:16px 20px;
border-bottom:1px solid rgba(255,255,255,0.15);
display:flex;
justify-content:space-between;
align-items:center;
}

.modal-header h2{
margin:0;
font-size:18px;
font-weight:800;
color:#fff;
}

.modal-close{
background:transparent;
border:1px solid rgba(255,255,255,0.3);
color:#fff;
padding:6px 12px;
border-radius:8px;
font-weight:700;
cursor:pointer;
}

.modal-body{
padding:20px;
}

.field{
margin-bottom:16px;
}

.field label{
display:block;
font-size:12px;
font-weight:800;
text-transform:uppercase;
margin-bottom:6px;
color:rgba(255,255,255,0.7);
}

.field input, .field select{
width:100%;
padding:12px 14px;
border-radius:10px;
border:1px solid rgba(255,255,255,0.25);
background:rgba(255,255,255,0.1);
color:#fff;
font-family:inherit;
font-weight:700;
font-size:16px;
}

.field input::placeholder{
color:rgba(255,255,255,0.4);
}

.field input[readonly]{
background:rgba(255,255,255,0.05);
opacity:0.7;
}

.modal-footer{
padding:16px 20px;
border-top:1px solid rgba(255,255,255,0.15);
display:flex;
gap:10px;
justify-content:flex-end;
}

.modal-footer button{
padding:12px 20px;
border-radius:10px;
border:none;
font-weight:800;
font-size:14px;
cursor:pointer;
}

.btn-primary{
background:var(--green-text);
color:#fff;
}

.btn-secondary{
background:rgba(255,255,255,0.1);
color:#fff;
border:1px solid rgba(255,255,255,0.25);
}

.modal-error{
color:var(--red-text);
background:var(--red-bg);
padding:10px;
border-radius:8px;
font-weight:700;
font-size:13px;
margin-top:10px;
}

/* ============================================ */
</style>
</head>

<body class="ready">
<header>
<div style="display:flex;align-items:center;gap:8px;">
<a href="./staff.html" aria-label="Open staff page" title="Staff">
<img src="./logo-negative.png" alt="IES Logo">
</a>
<a href="./here.html" style="font-size:10px;padding:4px 8px;background:rgba(255,255,255,0.15);border-radius:6px;color:#fff;text-decoration:none;font-weight:700;">Here</a>
<a href="./manual.html" style="font-size:10px;padding:4px 8px;background:rgba(255,255,255,0.15);border-radius:6px;color:#fff;text-decoration:none;font-weight:700;">Manual</a>
<a href="./staff.html" style="font-size:10px;padding:4px 8px;background:rgba(255,255,255,0.15);border-radius:6px;color:#fff;text-decoration:none;font-weight:700;">Staff</a>
</div>
<div class="clock" id="clock">--:--</div>
</header>

<main>
<div class="card">
<div class="pill" id="pill">READY</div>
<h1 class="status" id="status">SCAN YOUR CARD</h1>
<div class="sub" id="message">Brakfast Club & Junior Club</div>
<button class="register-btn" id="registerBtn" style="display:none;" onclick="openRegisterModal()">Register This Card</button>
</div>
</main>

<!-- Registration Modal -->
<div class="modal-overlay" id="registerModal">
<div class="modal">
<div class="modal-header">
<h2>Register New Card</h2>
<button class="modal-close" onclick="closeRegisterModal()">Cancel</button>
</div>
<div class="modal-body">
<div class="field">
<label>Card UID</label>
<input type="text" id="regCardUid" readonly>
</div>
<div class="field">
<label>Student Name *</label>
<input type="text" id="regName" placeholder="First Last">
</div>
<div class="field">
<label>Class *</label>
<select id="regClass">
<option value="">Select class</option>
<option value="4A">4A</option><option value="4B">4B</option><option value="4C">4C</option>
<option value="5A">5A</option><option value="5B">5B</option><option value="5C">5C</option>
<option value="6A">6A</option><option value="6B">6B</option><option value="6C">6C</option>
<option value="7A">7A</option><option value="7B">7B</option><option value="7C">7C</option>
<option value="8A">8A</option><option value="8B">8B</option><option value="8C">8C</option>
<option value="9A">9A</option><option value="9B">9B</option><option value="9C">9C</option>
</select>
</div>
<div class="field">
<label>Student Email</label>
<input type="text" id="regEmail" value="student.vasteras@engelska.se">
</div>
<div id="regError"></div>
</div>
<div class="modal-footer">
<button class="btn-secondary" onclick="closeRegisterModal()">Cancel</button>
<button class="btn-primary" onclick="submitRegistration()">Register & Check In</button>
</div>
</div>
</div>

<footer>
<div>Junior Club Portal</div>
<div>v3.2</div>
</footer>

<script>
/* ================= DOM BINDINGS ================= */
const pillEl    = document.getElementById("pill");
const statusEl  = document.getElementById("status");
const messageEl = document.getElementById("message");
const clockEl   = document.getElementById("clock");
/* ================================================ */

/* ================= CONFIG (UNCHANGED) ================= */
const ATT_FORM_URL =
"https://docs.google.com/forms/d/e/1FAIpQLSf5zEJQa4T8tRgKOQ2DQ80OqCkrElNcx5X_5Udg0GJ4vyvpRQ/formResponse";

const ATT = {
card_uid:"entry.1104238975",
event:"entry.1735508359",
device_id:"entry.452811867",
method:"entry.1237226768",
operator:"entry.1642343573",
note:"entry.1538254700",
club_id:"entry.164839595",
schema_version:"entry.2138280654"
};

const MAPPING_CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=348834218&single=true&output=csv";

const ATT_CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=1075501813&single=true&output=csv";

const DEVICE_ID="Door-1";
const CLUB_ID="IESV_JuniorClub";
const SCHEMA_VERSION="v3";
const DEBOUNCE_MS=5000;
const RESET_MS=2500;

const MAP_FORM_URL =
"https://docs.google.com/forms/d/e/1FAIpQLSfzE9xEgS_MibTe-ZmcncKs617SxMauPRAMWZIZlsJoQG6qAQ/formResponse";

const MAP_ENTRY = {
card_uid: "entry.1712147498",
student_email: "entry.1171642279",
student_name: "entry.2022534068",
class: "entry.1723675198",
status: "entry.1124037588",
pin: "entry.352224440",
note: "entry.523442266",
mapped_by: "entry.1680238241",
schema: "entry.1809813215"
};

/* ================= LOCAL SYNC KEYS ================= */
const LOCAL_SCANS_KEY = "juniorclub_local_scans_v1";
const LOCAL_MAPPING_KEY = "juniorclub_local_mapping_v1";
const LOCAL_REGISTERED_KEY = "juniorclub_local_registered_v1";

/* ====================================================== */

let knownActiveCards=new Set();
let mappingLoaded=false;
let stateByCard={};
let buffer="",lastKeyTime=0;
let lastScan={card:null,time:0};
let pendingUnknownCard = null;

/* mapping lookup so we can show student names */
let mappingByCard={};

/* ================= CLOCK ================= */
function updateClock(){
clockEl.textContent =
new Date().toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"});
}
setInterval(updateClock,1000); updateClock();

/* ================= UI ================= */
function resetUI(){
document.body.className="ready";
pillEl.textContent="READY";
statusEl.textContent="SCAN YOUR CARD";
messageEl.textContent="Breakfast Club & Junior Club Login";
document.getElementById("registerBtn").style.display="none";
pendingUnknownCard = null;
}

function showState(css,label,msg,showRegister=false){
document.body.className=css;
pillEl.textContent="LOGGED";
statusEl.textContent=label;
messageEl.textContent=msg;
document.getElementById("registerBtn").style.display = showRegister ? "inline-block" : "none";
}

function firstNameFromStudentName(studentName){
const s=(studentName||"").trim();
if(!s) return "";
return s.split(/\s+/)[0] || "";
}

function nameForCard(card){
const row=mappingByCard[card];
return firstNameFromStudentName(row?.student_name || row?.studentName || "");
}

/* ================= CSV ================= */
function splitCSVLine(line){
const out=[],len=line.length; let cur="",q=false;
for(let i=0;i<len;i++){
const c=line[i];
if(c==='"'){ q=!q; continue; }
if(c===',' && !q){ out.push(cur); cur=""; continue; }
cur+=c;
}
out.push(cur); return out.map(s=>s.trim());
}

function parseCSV(text){
const lines=text.trim().split("\n");
const headers=splitCSVLine(lines[0]);
return lines.slice(1).map(l=>{
const v=splitCSVLine(l),o={};
headers.forEach((h,i)=>o[h]=v[i]||"");
return o;
});
}

function parseEU(ts){
const m=ts&&ts.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4}) (\d{1,2}):(\d{2}):(\d{2})$/);
if(!m) return 0;
return new Date(+m[3],m[2]-1,+m[1],+m[4],+m[5],+m[6]).getTime();
}

/* ================= LOCAL STORAGE SYNC ================= */
function loadLocalScans(){
  try {
    const raw = localStorage.getItem(LOCAL_SCANS_KEY);
    if (!raw) return {};
    return JSON.parse(raw);
  } catch {
    return {};
  }
}

function saveLocalScans(scans){
  try {
    localStorage.setItem(LOCAL_SCANS_KEY, JSON.stringify(scans));
  } catch {
    /* ignore */
  }
}

function saveLocalMapping(mapping){
  try {
    localStorage.setItem(LOCAL_MAPPING_KEY, JSON.stringify(mapping));
  } catch {
    /* ignore */
  }
}

function loadLocalRegistered(){
  try {
    const raw = localStorage.getItem(LOCAL_REGISTERED_KEY);
    if (!raw) return {};
    const obj = JSON.parse(raw);
    // Clean up entries older than 24 hours
    const now = Date.now();
    const cutoff = now - (24 * 60 * 60 * 1000);
    for (const [card, rec] of Object.entries(obj)){
      if (rec._savedAt < cutoff) delete obj[card];
    }
    return obj;
  } catch {
    return {};
  }
}

function recordLocalScan(card, event, studentName, studentClass){
  const scans = loadLocalScans();
  const now = Date.now();
  
  // Clean up old scans (older than 24 hours)
  const cutoff = now - (24 * 60 * 60 * 1000);
  for (const [key, scan] of Object.entries(scans)){
    if (scan.timestamp < cutoff) delete scans[key];
  }
  
  // Record new scan
  scans[card] = {
    card_uid: card,
    event: event,
    timestamp: now,
    student_name: studentName || "",
    class: studentClass || ""
  };
  
  saveLocalScans(scans);
  
  // Notify other tabs
  localStorage.setItem("juniorclub_scan_notify", JSON.stringify({ card, event, timestamp: now }));
  localStorage.removeItem("juniorclub_scan_notify");
}

/* ================= DATA LOADING ================= */
async function loadMapping(){
const csv=await fetch(MAPPING_CSV_URL,{cache:"no-store"}).then(r=>r.text());
const rows=parseCSV(csv),latest={};
rows.forEach(r=>r.card_uid&&(latest[r.card_uid]=r));

// Merge locally registered cards (from staff.html)
const localRegistered = loadLocalRegistered();
for (const [card, rec] of Object.entries(localRegistered)){
  if (!latest[card] && rec.status === "active"){
    latest[card] = rec;
  }
}

mappingByCard=latest;

// Save mapping to localStorage for other pages
saveLocalMapping(latest);

knownActiveCards=new Set(
Object.values(latest).filter(r=>r.status==="active").map(r=>r.card_uid)
);
mappingLoaded=true;
}

async function loadLatestInOutState(){
const csv=await fetch(ATT_CSV_URL,{cache:"no-store"}).then(r=>r.text());
const rows=parseCSV(csv),latest={};
rows.forEach(r=>{
if(!r.card_uid) return;
if(r.event!=="IN"&&r.event!=="OUT") return;
const t=parseEU(r.Timestamp);
if(!latest[r.card_uid]||t>latest[r.card_uid].t)
latest[r.card_uid]={event:r.event,t};
});

// Merge with local scans (local scans take priority if newer)
const localScans = loadLocalScans();
for (const [card, scan] of Object.entries(localScans)){
  if (scan.event === "IN" || scan.event === "OUT"){
    const existing = latest[card];
    if (!existing || scan.timestamp > existing.t){
      latest[card] = { event: scan.event, t: scan.timestamp };
    }
  }
}

stateByCard=Object.fromEntries(Object.entries(latest).map(([k,v])=>[k,v.event]));
}

function postAttendance(card,event){
const d=new URLSearchParams();
d.append(ATT.card_uid,card);
d.append(ATT.event,event);
d.append(ATT.device_id,DEVICE_ID);
d.append(ATT.method,"RFID");
d.append(ATT.club_id,CLUB_ID);
d.append(ATT.schema_version,SCHEMA_VERSION);
fetch(ATT_FORM_URL,{method:"POST",mode:"no-cors",body:d});
}

/* ================= SCAN ================= */
document.addEventListener("keydown",e=>{
const now=Date.now();
if(e.key.length===1){
if(now-lastKeyTime>80) buffer="";
buffer+=e.key; lastKeyTime=now; return;
}
if(e.key==="Enter"){
const card=buffer.trim(); buffer="";
if(!card||!mappingLoaded) return;
if(lastScan.card===card&&now-lastScan.time<DEBOUNCE_MS) return;
lastScan={card,time:now};

if(!knownActiveCards.has(card)){
postAttendance(card,"UNKNOWN");
recordLocalScan(card, "UNKNOWN", "", "");
pendingUnknownCard = card;
showState("unknown","NEW CARD","Click below to register", true);
// Don't auto-reset - wait for registration or next scan
return;
}

const next=(stateByCard[card]==="IN")?"OUT":"IN";
stateByCard[card]=next;
postAttendance(card,next);

const mapping = mappingByCard[card] || {};
const fn=nameForCard(card);

// Record to localStorage for instant sync
recordLocalScan(card, next, mapping.student_name || "", mapping.class || "");

if(next==="IN"){
showState("in","WELCOME", fn || "You're checked in");
}else{
showState("out","GOODBYE", fn || "You're checked out");
}
setTimeout(resetUI,RESET_MS);
}
});

/* ================= REGISTRATION MODAL ================= */
function openRegisterModal(){
  if (!pendingUnknownCard) return;
  document.getElementById("regCardUid").value = pendingUnknownCard;
  document.getElementById("regName").value = "";
  document.getElementById("regClass").value = "";
  document.getElementById("regEmail").value = "student.vasteras@engelska.se";
  document.getElementById("regError").innerHTML = "";
  document.getElementById("registerModal").classList.add("show");
  document.getElementById("regName").focus();
}

function closeRegisterModal(){
  document.getElementById("registerModal").classList.remove("show");
}

function saveLocalRegistered(cardUid, rec){
  try {
    const raw = localStorage.getItem(LOCAL_REGISTERED_KEY);
    const all = raw ? JSON.parse(raw) : {};
    all[cardUid] = { ...rec, _savedAt: Date.now() };
    localStorage.setItem(LOCAL_REGISTERED_KEY, JSON.stringify(all));
    // Notify other tabs
    localStorage.setItem("juniorclub_register_notify", String(Date.now()));
    localStorage.removeItem("juniorclub_register_notify");
  } catch {
    /* ignore */
  }
}

async function submitRegistration(){
  const cardUid = document.getElementById("regCardUid").value.trim();
  const name = document.getElementById("regName").value.trim();
  const cls = document.getElementById("regClass").value.trim();
  const email = document.getElementById("regEmail").value.trim();
  const errorEl = document.getElementById("regError");
  
  if (!name || !cls){
    errorEl.innerHTML = '<div class="modal-error">Name and Class are required.</div>';
    return;
  }
  
  // Post to Google Form
  const d = new URLSearchParams();
  d.append(MAP_ENTRY.card_uid, cardUid);
  d.append(MAP_ENTRY.student_email, email);
  d.append(MAP_ENTRY.student_name, name);
  d.append(MAP_ENTRY.class, cls);
  d.append(MAP_ENTRY.status, "active");
  d.append(MAP_ENTRY.pin, "");
  d.append(MAP_ENTRY.note, "Registered at scan");
  d.append(MAP_ENTRY.mapped_by, "scan-page");
  d.append(MAP_ENTRY.schema, SCHEMA_VERSION);
  
  fetch(MAP_FORM_URL, {method:"POST", mode:"no-cors", body:d});
  
  // Save to localStorage for instant recognition
  const rec = {
    card_uid: cardUid,
    student_email: email,
    student_name: name,
    class: cls,
    status: "active",
    _savedAt: Date.now()
  };
  saveLocalRegistered(cardUid, rec);
  
  // Add to known cards immediately
  mappingByCard[cardUid] = rec;
  knownActiveCards.add(cardUid);
  
  // Check them in
  stateByCard[cardUid] = "IN";
  postAttendance(cardUid, "IN");
  recordLocalScan(cardUid, "IN", name, cls);
  
  closeRegisterModal();
  
  // Show welcome
  const firstName = name.split(/\s+/)[0] || name;
  showState("in", "WELCOME", firstName);
  setTimeout(resetUI, RESET_MS);
}

/* ================= INIT ================= */
resetUI();
loadMapping();
loadLatestInOutState();

// Listen for new card registrations from staff.html
window.addEventListener("storage", (e) => {
  if (e.key === "juniorclub_register_notify"){
    // Reload mapping to pick up newly registered card
    loadMapping();
  }
});
</script>
</body>
</html>
