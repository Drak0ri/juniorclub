<!-- /here.html (v3.1 - localStorage instant sync) -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Junior Club – Here Today</title>

<link rel="icon" href="./ies.ico" type="image/x-icon">
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --navy:#102d69;
  --bg:#f6f8fb;
  --card:#ffffff;
  --text:#102d69;
  --muted:#5b6b86;
  --border:#d0d7e2;
  --present:#0b6b2f;
  --out:#b00020;
  --pill:#eef2f9;
}

body.dark{
  --bg:#0a1226;
  --card:#0f1b36;
  --text:#eaf0ff;
  --muted:#b7c4e6;
  --border:#223154;
  --pill:#16254a;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  font-family:"Open Sans",Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  height:100vh;
  overflow:hidden;
}

header{
  height:64px;
  padding:10px 14px;
  background:var(--navy);
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.brand{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:240px;
}
.brand a{
  display:flex;
  align-items:center;
  gap:10px;
  color:#fff;
  text-decoration:none;
  font-weight:800;
}
.brand img{ height:34px; }

.controls{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-end;
}

button{
  border:1px solid rgba(255,255,255,0.25);
  background:rgba(255,255,255,0.12);
  color:#fff;
  padding:7px 10px;
  border-radius:10px;
  font-weight:800;
  cursor:pointer;
}
button:hover{ background:rgba(255,255,255,0.18); }
button:active{ transform:translateY(1px); }

.meta{
  height:34px;
  padding:8px 14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  border-bottom:1px solid var(--border);
  background:var(--card);
  color:var(--muted);
  font-size:12px;
  font-weight:700;
}

.meta .pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:5px 10px;
  border-radius:999px;
  background:var(--pill);
  border:1px solid var(--border);
  color:var(--muted);
  white-space:nowrap;
}

.meta .warn{ color:#000; background:#fff7b2; border-color:#f1dd6d; }
.meta .live{ color:#fff; background:var(--present); border-color:var(--present); }

/* Compact (when Just-left hidden): keep it cleaner */
body.compact .meta{
  height:28px;
  font-size:11px;
  padding:6px 12px;
}
body.compact #metaLeft.pill{
  padding:4px 10px;
}

main{
  height:calc(100vh - 64px - 34px);
  display:grid;
  grid-template-rows:1fr auto;
  gap:10px;
  padding:12px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  min-height:0;
}

.card-head{
  padding:12px 14px;
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:10px;
  border-bottom:1px solid var(--border);
}

.card-head h1{
  margin:0;
  font-size:18px;
  font-weight:900;
  letter-spacing:.2px;
}

.card-head .count{
  font-size:14px;
  font-weight:900;
  color:var(--present);
}

.grid-wrap{
  flex:1;
  min-height:0;
  padding:10px 12px 12px;
}

.grid{
  width:100%;
  height:100%;
  display:grid;
  gap:10px;
  align-content:start;
}

.name{
  display:flex;
  align-items:center;
  justify-content:center;
  border:1px solid var(--border);
  border-radius:14px;
  background:transparent;
  font-weight:900;
  letter-spacing:.3px;
  text-align:center;
  padding:10px;
  user-select:none;
  white-space:nowrap;
}

.footer-card{
  padding:10px 12px;
  display:flex;
  gap:10px;
  align-items:stretch;
  justify-content:space-between;
}

.footer-card .card{
  flex:1;
}

.small{
  font-size:12px;
  color:var(--muted);
  font-weight:800;
}

.out-grid{
  height:96px;
}

.out-grid .grid{
  height:100%;
  align-content:center;
}

.banner{
  position:fixed;
  left:12px;
  right:12px;
  bottom:12px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px 12px;
  display:none;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  box-shadow:0 10px 30px rgba(0,0,0,.18);
  z-index:9998;
}
.banner.show{ display:flex; }
.banner strong{ color:var(--out); }
.banner .hint{ color:var(--muted); font-size:12px; font-weight:800; }

.gate{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.55);
  padding:16px;
  z-index:9999;
}
.gate.show{ display:flex; }

.gate .panel{
  width:min(520px, 96vw);
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  overflow:hidden;
}
.gate .panel-head{
  padding:12px 14px;
  background:var(--navy);
  color:#fff;
  font-weight:900;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.gate .panel-body{
  padding:14px;
  display:grid;
  gap:10px;
}
.gate label{
  font-size:12px;
  font-weight:900;
  color:var(--muted);
}
.gate input{
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  font-family:inherit;
  font-size:16px;
  font-weight:800;
  color:var(--text);
  background:transparent;
}
.gate .row{
  display:flex;
  gap:8px;
  justify-content:flex-end;
}
.gate .panel-body .note{
  font-size:12px;
  color:var(--muted);
  font-weight:800;
  line-height:1.35;
}
.gate .err{
  color:var(--out);
  font-weight:900;
  font-size:12px;
  min-height:16px;
}
.gate .btn{
  background:var(--navy);
  color:#fff;
  border:none;
  padding:10px 12px;
  border-radius:12px;
  font-weight:900;
  cursor:pointer;
}
.gate .btn.secondary{
  background:transparent;
  color:var(--navy);
  border:1px solid var(--border);
}

/* Kiosk mode (fullscreen): hide UI, keep only names + tiny overlays */
.kioskbar,
.kioskmeta{
  position:fixed;
  z-index:9997;
  display:none;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(0,0,0,0.55);
  color:#fff;
  font-weight:900;
  font-size:12px;
  letter-spacing:.2px;
  opacity:1;
  transition:opacity .18s ease;
}

.kioskbar{
  right:14px;
  bottom:14px;
}

.kioskmeta{
  left:14px;
  bottom:14px;
  font-weight:800;
  opacity:0.9;
}

body.kiosk .kioskbar,
body.kiosk .kioskmeta{
  display:inline-flex;
}

body.kiosk header{ display:none; }
body.kiosk .meta{ display:none; }
body.kiosk main{
  height:100vh;
  padding:12px;
}

/* Auto-hide in kiosk mode after inactivity */
body.kiosk.kiosk-ui-hidden .kioskbar,
body.kiosk.kiosk-ui-hidden .kioskmeta{
  opacity:0;
  pointer-events:none;
}
</style>
</head>

<body>
<header>
  <div class="brand">
    <a href="./staff.html" title="Staff page">
      <img src="./logo-negative.png" alt="IES Logo">
      <span>Here Today</span>
    </a>
  </div>

  <div class="controls">
    <button id="btnDark" type="button">Dark mode</button>
    <button id="btnFull" type="button">Fullscreen</button>
    <button id="btnRefresh" type="button">Refresh</button>
  </div>
</header>

<div class="meta">
  <div class="pill" id="metaLeft">Last updated: —</div>
  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
    <div class="pill live" id="metaLive">⚡ Live sync</div>
    <div class="pill" id="metaStale">Stale: —</div>
    <div class="pill" id="metaLag">Note: Google Sheets delayed 10–60s</div>
  </div>
</div>

<div class="kioskmeta" id="kioskMeta">Updated: —</div>
<div class="kioskbar" id="kioskBar">Total present: <span id="kioskCount">0</span></div>

<main id="main">
  <div class="card">
    <div class="card-head">
      <h1>Present</h1>
      <div class="count" id="presentCount">0</div>
    </div>
    <div class="grid-wrap">
      <div class="grid" id="presentGrid"></div>
    </div>
  </div>

  <div class="footer-card" id="leftWrap">
    <div class="card">
      <div class="card-head">
        <h1>Just left (last 5 minutes)</h1>
        <div class="small" id="leftCount">0</div>
      </div>
      <div class="grid-wrap out-grid">
        <div class="grid" id="leftGrid"></div>
      </div>
    </div>
  </div>
</main>

<div class="banner" id="banner">
  <div>
    <strong id="bannerTitle">Data delay</strong>
    <div class="hint" id="bannerMsg">—</div>
  </div>
  <button type="button" id="bannerClose">Close</button>
</div>

<div class="gate" id="gate">
  <div class="panel">
    <div class="panel-head">
      <div>Staff access</div>
      <a href="./index.html" style="color:#fff;text-decoration:underline;font-weight:900;">Scan page</a>
    </div>
    <div class="panel-body">
      <div class="note">
        This is a lightweight "staff-only" gate for a static site. It deters casual access but is not strong security.
        For real access control, you'd host this behind your school login (Google Workspace / intranet / Apps Script).
      </div>

      <div>
        <label>Enter PIN</label>
        <input id="gatePin" type="password" autocomplete="off" inputmode="numeric" placeholder="PIN">
        <div class="err" id="gateErr"></div>
      </div>

      <div class="row">
        <button class="btn secondary" type="button" id="gateRemember">Remember on this device</button>
        <button class="btn" type="button" id="gateEnter">Enter</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===========================
CONFIG
=========================== */
const ATT_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=1075501813&single=true&output=csv";

const MAP_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=348834218&single=true&output=csv";

const JUST_LEFT_WINDOW_MS = 5 * 60 * 1000;

const POLL_MS_BASE = 5000;
const POLL_MS_BURST = 2000;
const BURST_FOR_MS = 30000;

const STALE_WARN_MIN = 5;

const FONT_MIN = 18;
const FONT_MAX = 72;

const STAFF_PIN = ""; // optional: set a PIN (e.g. "1234") to enable the lightweight gate (NOT strong security)

const KIOSK_HIDE_MS = 5000;

/* ================= LOCAL SYNC KEYS ================= */
const LOCAL_SCANS_KEY = "juniorclub_local_scans_v1";
const LOCAL_MAPPING_KEY = "juniorclub_local_mapping_v1";

/* ===========================
STATE
=========================== */
let pollTimer = null;
let burstUntilTs = 0;

let lastAcceptedLatestAttTs = 0;
let lastAcceptedAttRows = 0;

let lastAcceptedLatestMapTs = 0;
let lastAcceptedMapRows = 0;

let mappingByCard = {};
let lastError = null;

let kioskHideTimer = null;

/* ===========================
UI HOOKS
=========================== */
const mainEl = document.getElementById("main");
const leftWrap = document.getElementById("leftWrap");

const presentGrid = document.getElementById("presentGrid");
const leftGrid = document.getElementById("leftGrid");
const presentCount = document.getElementById("presentCount");
const leftCount = document.getElementById("leftCount");

const metaLeft = document.getElementById("metaLeft");
const metaStale = document.getElementById("metaStale");
const metaLag = document.getElementById("metaLag");
const metaLive = document.getElementById("metaLive");

const btnDark = document.getElementById("btnDark");
const btnFull = document.getElementById("btnFull");
const btnRefresh = document.getElementById("btnRefresh");

const banner = document.getElementById("banner");
const bannerTitle = document.getElementById("bannerTitle");
const bannerMsg = document.getElementById("bannerMsg");
const bannerClose = document.getElementById("bannerClose");

const kioskCount = document.getElementById("kioskCount");
const kioskMeta = document.getElementById("kioskMeta");

const gate = document.getElementById("gate");
const gatePin = document.getElementById("gatePin");
const gateErr = document.getElementById("gateErr");
const gateRemember = document.getElementById("gateRemember");
const gateEnter = document.getElementById("gateEnter");

/* ===========================
UTIL
=========================== */
function showBanner(title, msg){
  bannerTitle.textContent = title;
  bannerMsg.textContent = msg;
  banner.classList.add("show");
}
function hideBanner(){ banner.classList.remove("show"); }

bannerClose.addEventListener("click", hideBanner);

function nowStr(){
  return new Date().toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
}
function minutesBetween(aTs, bTs){
  return Math.max(0, Math.floor((aTs - bTs) / 60000));
}
function startOfTodayLocalTs(){
  const d = new Date();
  d.setHours(0,0,0,0);
  return d.getTime();
}
function parseEU(ts){
  if(!ts) return 0;
  const m = ts.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4}) (\d{1,2}):(\d{2}):(\d{2})$/);
  if(!m) return 0;
  return new Date(
    Number(m[3]),
    Number(m[2]) - 1,
    Number(m[1]),
    Number(m[4]),
    Number(m[5]),
    Number(m[6])
  ).getTime();
}

/* RFC4180-ish CSV parser */
function parseCSV(text){
  const rows = [];
  let row = [];
  let field = "";
  let inQuotes = false;

  const pushField = () => { row.push(field); field = ""; };
  const pushRow = () => { rows.push(row); row = []; };

  const s = (text || "").replace(/\r\n/g, "\n").replace(/\r/g, "\n");

  for (let i = 0; i < s.length; i++){
    const c = s[i];

    if (c === '"'){
      const next = s[i + 1];
      if (inQuotes && next === '"'){
        field += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
      continue;
    }

    if (!inQuotes && c === ","){ pushField(); continue; }
    if (!inQuotes && c === "\n"){ pushField(); pushRow(); continue; }
    field += c;
  }
  pushField();
  pushRow();

  const headers = (rows.shift() || []).map(h => (h || "").trim());
  return rows
    .filter(r => r.some(v => (v || "").trim() !== ""))
    .map(r => {
      const o = {};
      headers.forEach((h, idx) => (o[h] = (r[idx] ?? "").trim()));
      return o;
    });
}

function clearNode(node){
  while (node.firstChild) node.removeChild(node.firstChild);
}

function parseStudentName(full){
  const s = (full || "").trim().replace(/\s+/g, " ");
  if (!s) return { first:"", lastInitial:"" };
  const parts = s.split(" ");
  const first = parts[0] || "";
  const last = parts.length > 1 ? parts[parts.length - 1] : "";
  const lastInitial = last ? last[0].toUpperCase() : "";
  return { first, lastInitial };
}

function buildDisplayNames(presentStudents){
  const firstCounts = new Map();
  const parsed = presentStudents.map(p => {
    const n = parseStudentName(p.student_name);
    const firstLower = (n.first || "").toLowerCase();
    firstCounts.set(firstLower, (firstCounts.get(firstLower) || 0) + 1);
    return { ...p, _first:n.first, _lastInitial:n.lastInitial };
  });

  return parsed.map(p => {
    const key = (p._first || "").toLowerCase();
    const dup = (firstCounts.get(key) || 0) > 1;
    const label = dup && p._lastInitial ? `${p._first} ${p._lastInitial}` : p._first || p.student_name || "";
    return { ...p, label };
  });
}

/* ===========================
LOCAL STORAGE SYNC
=========================== */
function loadLocalScans(){
  try {
    const raw = localStorage.getItem(LOCAL_SCANS_KEY);
    if (!raw) return {};
    return JSON.parse(raw);
  } catch {
    return {};
  }
}

function loadLocalMapping(){
  try {
    const raw = localStorage.getItem(LOCAL_MAPPING_KEY);
    if (!raw) return {};
    return JSON.parse(raw);
  } catch {
    return {};
  }
}

/* ===========================
FONT FIT + GRID LAYOUT
=========================== */
function bestLayout(container, items){
  const rect = container.getBoundingClientRect();
  const w = Math.max(1, rect.width);
  const h = Math.max(1, rect.height);

  const n = items.length;
  if (n <= 0) return { cols: 1, font: FONT_MAX };

  const maxChars = Math.max(1, ...items.map(x => (x.label || "").length));

  const minCols = 1;
  const maxCols = Math.min(8, Math.max(1, n));

  let best = { cols: 1, font: FONT_MIN };

  for (let cols = minCols; cols <= maxCols; cols++){
    const rows = Math.ceil(n / cols);
    const cellW = w / cols;
    const cellH = h / rows;

    const fontFromH = cellH * 0.62;
    const fontFromW = (cellW * 0.92) / (maxChars * 0.58);

    const font = Math.max(FONT_MIN, Math.min(FONT_MAX, Math.floor(Math.min(fontFromH, fontFromW))));

    if (font > best.font) best = { cols, font };
  }
  return best;
}

function renderNameGrid(gridEl, items){
  clearNode(gridEl);

  const layout = bestLayout(gridEl, items);
  gridEl.style.gridTemplateColumns = `repeat(${layout.cols}, minmax(0, 1fr))`;

  items.forEach(it=>{
    const div = document.createElement("div");
    div.className = "name";
    div.style.fontSize = `${layout.font}px`;
    div.style.lineHeight = "1.05";
    div.textContent = it.label || "";
    gridEl.appendChild(div);
  });
}

/* ===========================
KIOSK UI AUTO-HIDE
=========================== */
function isKiosk(){ return document.body.classList.contains("kiosk"); }

function showKioskUi(){
  if (!isKiosk()) return;
  document.body.classList.remove("kiosk-ui-hidden");
  if (kioskHideTimer) clearTimeout(kioskHideTimer);
  kioskHideTimer = setTimeout(()=> {
    if (isKiosk()) document.body.classList.add("kiosk-ui-hidden");
  }, KIOSK_HIDE_MS);
}

function stopKioskUiTimer(){
  if (kioskHideTimer) clearTimeout(kioskHideTimer);
  kioskHideTimer = null;
  document.body.classList.remove("kiosk-ui-hidden");
}

["mousemove","mousedown","keydown","touchstart"].forEach(evt=>{
  window.addEventListener(evt, showKioskUi, { passive:true });
});

/* ===========================
DATA LOAD + SNAPSHOT GUARD
=========================== */
async function fetchCsv(url){
  const u = `${url}&_=${Date.now()}`;
  const r = await fetch(u, { cache:"no-store" });
  return r.text();
}

function acceptOrRejectSnapshot({ rows, latestTs }, lastAcceptedTs, lastAcceptedRows){
  const gotClearlyOlder = lastAcceptedTs > 0 && (latestTs === 0 || latestTs + 2000 < lastAcceptedTs);
  const gotRowDrop = lastAcceptedRows > 0 && rows + 2 < lastAcceptedRows && latestTs <= lastAcceptedTs;
  return !(gotClearlyOlder || gotRowDrop);
}

function setMeta(latestAttTs){
  const updated = nowStr();
  const kioskStale = latestAttTs ? `Stale: ${minutesBetween(Date.now(), latestAttTs)}m` : "Stale: —";
  kioskMeta.textContent = `Updated: ${updated} • ${kioskStale}`;

  if (!latestAttTs){
    metaLeft.textContent = `Updated: ${updated}`;
    metaStale.textContent = "Stale: —";
    metaStale.className = "pill";
    return;
  }

  const mins = minutesBetween(Date.now(), latestAttTs);
  const warn = mins >= STALE_WARN_MIN;

  const staleText = warn ? `Stale: ${mins}m ⚠️` : `Stale: ${mins}m`;
  metaStale.textContent = staleText;
  metaStale.className = warn ? "pill warn" : "pill";

  if (document.body.classList.contains("compact")){
    metaLeft.textContent = `Updated: ${updated} | ${staleText}`;
    metaStale.style.display = "none";
    metaLag.style.display = "none";
  } else {
    metaLeft.textContent = `Last updated: ${updated}`;
    metaStale.style.display = "inline-flex";
    metaLag.style.display = "inline-flex";
  }
}

function startBurst(){
  burstUntilTs = Date.now() + BURST_FOR_MS;
  restartPolling();
}

function currentPollMs(){
  return Date.now() < burstUntilTs ? POLL_MS_BURST : POLL_MS_BASE;
}

function restartPolling(){
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(loadAndRender, currentPollMs());
}

function computeLatestTs(rows, tsField){
  let t = 0;
  rows.forEach(r=>{
    const v = parseEU(r[tsField]);
    if (v > t) t = v;
  });
  return t;
}

function buildLatestByCardToday(attRows, localScans){
  const dayStart = startOfTodayLocalTs();
  const latest = {};

  // Process Google Sheets data
  attRows.forEach(r=>{
    const t = parseEU(r.Timestamp);
    if (!t || t < dayStart) return;
    if (!r.card_uid) return;

    const ev = (r.event || "").trim();
    if (ev !== "IN" && ev !== "OUT" && ev !== "UNKNOWN") return;

    const prev = latest[r.card_uid];
    if (!prev || t >= prev._t){
      latest[r.card_uid] = { ...r, _t: t };
    }
  });

  // Merge with local scans (local takes priority if newer)
  for (const [card, scan] of Object.entries(localScans)){
    if (scan.timestamp < dayStart) continue;
    const ev = (scan.event || "").trim();
    if (ev !== "IN" && ev !== "OUT" && ev !== "UNKNOWN") continue;

    const prev = latest[card];
    if (!prev || scan.timestamp >= prev._t){
      latest[card] = {
        card_uid: card,
        event: ev,
        _t: scan.timestamp,
        _local: true
      };
    }
  }

  return latest;
}

function buildLatestMapping(mapRows, localMapping){
  const mapping = {};
  
  // Process Google Sheets data
  mapRows.forEach(r=>{
    if (!r.card_uid) return;
    const t = parseEU(r.Timestamp);
    const prev = mapping[r.card_uid];
    if (!prev || t >= prev._t){
      mapping[r.card_uid] = { ...r, _t: t };
    }
  });

  // Merge with local mapping (from index.html)
  for (const [card, rec] of Object.entries(localMapping)){
    if (!mapping[card]){
      mapping[card] = { ...rec, _t: 0 };
    }
  }

  return mapping;
}

function normalizePresent(latestByCard, mapping){
  const present = [];
  const justLeft = [];

  const now = Date.now();

  Object.values(latestByCard).forEach(scan=>{
    const m = mapping[scan.card_uid];
    if (!m) return;
    if ((m.status || "").trim() !== "active") return;

    const studentName = (m.student_name || "").trim();
    if (!studentName) return;

    const ev = (scan.event || "").trim();
    if (ev === "IN"){
      present.push({
        card_uid: scan.card_uid,
        student_name: studentName,
        class: (m.class || "").trim(),
        _t: scan._t,
        _local: scan._local || false
      });
      return;
    }

    if (ev === "OUT" && scan._t && (now - scan._t) <= JUST_LEFT_WINDOW_MS){
      justLeft.push({
        card_uid: scan.card_uid,
        student_name: studentName,
        class: (m.class || "").trim(),
        _t: scan._t,
        _local: scan._local || false
      });
    }
  });

  present.sort((a,b)=> (a.class || "").localeCompare(b.class || "") || (a.student_name || "").localeCompare(b.student_name || ""));
  justLeft.sort((a,b)=> b._t - a._t);

  const presentDisplay = buildDisplayNames(present);
  const leftDisplay = buildDisplayNames(justLeft);

  return { presentDisplay, leftDisplay };
}

function setJustLeftVisible(hasAny){
  leftWrap.style.display = hasAny ? "flex" : "none";
  mainEl.style.gridTemplateRows = hasAny ? "1fr auto" : "1fr";
  document.body.classList.toggle("compact", !hasAny);
}

async function loadAndRender(){
  try{
    lastError = null;

    // Load local data first (instant)
    const localScans = loadLocalScans();
    const localMapping = loadLocalMapping();

    const [attText, mapText] = await Promise.all([
      fetchCsv(ATT_CSV),
      fetchCsv(MAP_CSV)
    ]);

    const attRows = parseCSV(attText);
    const mapRows = parseCSV(mapText);

    const latestAttTs = computeLatestTs(attRows, "Timestamp");
    const latestMapTs = computeLatestTs(mapRows, "Timestamp");

    const attOk = acceptOrRejectSnapshot(
      { rows: attRows.length, latestTs: latestAttTs },
      lastAcceptedLatestAttTs,
      lastAcceptedAttRows
    );

    const mapOk = acceptOrRejectSnapshot(
      { rows: mapRows.length, latestTs: latestMapTs },
      lastAcceptedLatestMapTs,
      lastAcceptedMapRows
    );

    if (!attOk){
      setMeta(lastAcceptedLatestAttTs);
      showBanner("Data delay", "Google served an older attendance snapshot. Waiting for the newest snapshot…");
      return;
    }

    if (!mapOk && Object.keys(mappingByCard).length){
      setMeta(latestAttTs);
      showBanner("Data delay", "Google served an older mapping snapshot. Keeping newest mapping view…");
    } else {
      hideBanner();
    }

    lastAcceptedLatestAttTs = Math.max(lastAcceptedLatestAttTs, latestAttTs);
    lastAcceptedAttRows = attRows.length;

    if (mapOk){
      lastAcceptedLatestMapTs = Math.max(lastAcceptedLatestMapTs, latestMapTs);
      lastAcceptedMapRows = mapRows.length;
      mappingByCard = buildLatestMapping(mapRows, localMapping);
    }

    const latestByCardToday = buildLatestByCardToday(attRows, localScans);
    const { presentDisplay, leftDisplay } = normalizePresent(latestByCardToday, mappingByCard);

    presentCount.textContent = String(presentDisplay.length);
    leftCount.textContent = String(leftDisplay.length);
    kioskCount.textContent = String(presentDisplay.length);

    renderNameGrid(presentGrid, presentDisplay);
    renderNameGrid(leftGrid, leftDisplay);

    const hasLeft = leftDisplay.length > 0;
    setJustLeftVisible(hasLeft);

    setMeta(latestAttTs);

    startBurst();
    showKioskUi();

  }catch(e){
    lastError = (e && e.message) ? e.message : String(e);
    showBanner("Error", lastError);
  }
}

/* Listen for scan events from index.html */
window.addEventListener("storage", (e) => {
  if (e.key === "juniorclub_scan_notify"){
    // Instant refresh when a scan happens
    loadAndRender();
  }
});

/* Resize → recompute layout without reloading data */
let resizeTimer = null;
window.addEventListener("resize", ()=>{
  if (resizeTimer) clearTimeout(resizeTimer);
  resizeTimer = setTimeout(()=>{
    const presentItems = Array.from(presentGrid.children).map(el => ({ label: el.textContent || "" }));
    const leftItems = Array.from(leftGrid.children).map(el => ({ label: el.textContent || "" }));
    renderNameGrid(presentGrid, presentItems);
    renderNameGrid(leftGrid, leftItems);
  }, 120);
});

/* ===========================
DARK MODE + FULLSCREEN
=========================== */
function setDark(on){
  document.body.classList.toggle("dark", !!on);
  localStorage.setItem("here_dark", on ? "1" : "0");
  btnDark.textContent = on ? "Light mode" : "Dark mode";
}
setDark(localStorage.getItem("here_dark") === "1");

btnDark.addEventListener("click", ()=>{
  setDark(!document.body.classList.contains("dark"));
});

async function toggleFullscreen(){
  try{
    if (!document.fullscreenElement){
      await document.documentElement.requestFullscreen();
      btnFull.textContent = "Exit fullscreen";
    } else {
      await document.exitFullscreen();
      btnFull.textContent = "Fullscreen";
    }
  }catch{
    /* ignore */
  }
}

btnFull.addEventListener("click", toggleFullscreen);

document.addEventListener("fullscreenchange", ()=>{
  const isFs = !!document.fullscreenElement;
  document.body.classList.toggle("kiosk", isFs);
  btnFull.textContent = isFs ? "Exit fullscreen" : "Fullscreen";
  if (isFs) showKioskUi();
  else stopKioskUiTimer();
});

btnRefresh.addEventListener("click", ()=>{
  burstUntilTs = Date.now() + BURST_FOR_MS;
  restartPolling();
  loadAndRender();
});

/* ===========================
LIGHTWEIGHT STAFF GATE (OPTIONAL)
=========================== */
function gateEnabled(){ return (STAFF_PIN || "").trim().length > 0; }

function gateIsOpen(){
  if (!gateEnabled()) return true;
  return localStorage.getItem("here_gate_ok") === "1";
}

function openGate(){
  gate.classList.add("show");
  gatePin.value = "";
  gateErr.textContent = "";
  gatePin.focus();
}

function closeGate(){
  gate.classList.remove("show");
}

function tryGate(remember){
  const pin = (gatePin.value || "").trim();
  if (pin !== (STAFF_PIN || "").trim()){
    gateErr.textContent = "Incorrect PIN.";
    return false;
  }
  if (remember){
    localStorage.setItem("here_gate_ok", "1");
  }
  closeGate();
  return true;
}

gateRemember.addEventListener("click", ()=>tryGate(true));
gateEnter.addEventListener("click", ()=>tryGate(false));
gatePin.addEventListener("keydown", (e)=>{
  if (e.key === "Enter") tryGate(false);
});

if (!gateIsOpen()){
  openGate();
}

/* ===========================
INIT
=========================== */
(function init(){
  setJustLeftVisible(false);
  restartPolling();
  loadAndRender();
})();
</script>
</body>
</html>
