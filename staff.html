<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Junior Club – Staff</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --navy:#102d69; --bg:#f6f8fb; --border:#d0d7e2;
  --warn:#fff7b2; --danger:#b00020; --ok:#0b6b2f;
}
body{ margin:0; font-family:"Open Sans",Arial,sans-serif; background:var(--bg); color:#102d69; }
header{ background:var(--navy); color:#fff; padding:14px 18px; display:flex; justify-content:space-between; align-items:center; }
header input{ padding:6px 8px; border-radius:6px; border:none; }
button{ background:var(--navy); color:#fff; border:none; padding:6px 10px; border-radius:6px; font-weight:700; cursor:pointer; }
button.secondary{ background:#fff; color:var(--navy); border:1px solid var(--border); }
main{ max-width:1200px; margin:20px auto; padding:0 16px; }
.card{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; }
.big{ font-size:44px; font-weight:800; }
table{ width:100%; border-collapse:collapse; }
th,td{ padding:10px; border-bottom:1px solid var(--border); }
tr.unknown{ background:var(--warn); }
.badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800; }
.badge.ok{ color:var(--ok); } .badge.bad{ color:var(--danger); }
.banner{
  background:rgba(176,0,32,.92); color:#fff; padding:10px 12px; border-radius:12px;
  display:none; font-size:13px; font-weight:800; margin-bottom:12px;
}

/* Modal */
.modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; }
.modal-content{ background:#fff; width:420px; padding:16px; border-radius:12px; }
.modal-content label{ display:block; font-size:12px; font-weight:700; margin-top:10px; }
.modal-content input, .modal-content select{ width:100%; padding:6px; }
.error{ color:var(--danger); font-weight:700; font-size:13px; }
.success{ color:var(--ok); font-weight:700; font-size:13px; }
.grid{ display:grid; grid-template-columns:1fr; gap:16px; }
@media (min-width: 980px){ .grid{ grid-template-columns: 1fr 1fr; } }
</style>
</head>

<body>
<header>
  <strong>Junior Club – Staff</strong>
  <div>
    <input id="operator" placeholder="staff email">
    <button onclick="saveOperator()">Save</button>
    <button class="secondary" onclick="reloadAll()">Refresh</button>
  </div>
</header>

<main>
  <div id="banner" class="banner"></div>

  <div class="grid">

    <div>
      <div class="card">
        <h2>Currently Present</h2>
        <div class="big" id="presentCount">–</div>
      </div>

      <div class="card">
        <h2>Who’s Here Now</h2>
        <table>
          <thead>
            <tr><th>Name</th><th>Class</th><th>Time IN</th><th>Card</th><th>Action</th></tr>
          </thead>
          <tbody id="presentTable"></tbody>
        </table>
      </div>
    </div>

    <div>
      <div class="card">
        <h2>Unknown Cards Queue</h2>
        <div style="margin-bottom:10px; font-size:13px; font-weight:700; opacity:.85;">
          These do not count as attendance. They are cards presented that are not mapped as active.
        </div>
        <table>
          <thead>
            <tr><th>Time</th><th>Card</th><th>Device</th><th>Action</th></tr>
          </thead>
          <tbody id="unknownTable"></tbody>
        </table>
      </div>
    </div>

  </div>
</main>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Register / Edit Student</h3>

    <label>Card UID (locked)</label>
    <input id="m_card" disabled>

    <label>Student name</label>
    <input id="m_name">

    <label>Student email</label>
    <input id="m_email">

    <label>Class</label>
    <input id="m_class">

    <label>Status</label>
    <select id="m_status">
      <option value="active">active</option>
      <option value="inactive">inactive</option>
    </select>

    <label>PIN (optional)</label>
    <input id="m_pin">

    <label>Note</label>
    <input id="m_note">

    <div id="modalError" class="error"></div>
    <div id="modalSuccess" class="success"></div>

    <div style="margin-top:12px;text-align:right">
      <button class="secondary" onclick="closeModal()">Cancel</button>
      <button onclick="submitMapping()">Save</button>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG (FROZEN) ===== */
const ATT_CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=1075501813&single=true&output=csv";
const MAP_CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=348834218&single=true&output=csv";
const MAP_FORM="https://docs.google.com/forms/d/e/1FAIpQLSfzE9xEgS_MibTe-ZmcncKs617SxMauPRAMWZIZlsJoQG6qAQ/formResponse";
const MAP={
  card:"entry.1712147498",
  email:"entry.1171642279",
  name:"entry.2022534068",
  class:"entry.1723675198",
  status:"entry.1124037588",
  pin:"entry.352224440",
  note:"entry.523442266",
  mapped_by:"entry.1680238241",
  schema:"entry.1809813215"
};
/* =========================== */

const banner = document.getElementById("banner");
function showBanner(msg){
  banner.textContent = msg;
  banner.style.display = "block";
}

function splitCSVLine(line){
  const out=[]; let cur=""; let q=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c==='"'){
      if(q && line[i+1]==='"'){ cur+='"'; i++; }
      else q=!q;
    } else if(c===',' && !q){
      out.push(cur); cur="";
    } else cur+=c;
  }
  out.push(cur);
  return out.map(s=>s.trim());
}
function parseCSV(text){
  const lines = text.trim().split("\n");
  const headers = splitCSVLine(lines[0]);
  const rows = [];
  for(const l of lines.slice(1)){
    if(!l.trim()) continue;
    const vals = splitCSVLine(l);
    const obj = {};
    headers.forEach((h,i)=> obj[h] = (vals[i] || "").trim());
    rows.push(obj);
  }
  return rows;
}

let mappingLatestByCard = {};
let activeMappedCards = new Set();
let pins = new Set();
let attendance = [];

function saveOperator(){ localStorage.setItem("op", document.getElementById("operator").value.trim()); }

async function reloadAll(){
  banner.style.display = "none";

  let attText="", mapText="";
  try{
    [attText, mapText] = await Promise.all([
      fetch(ATT_CSV,{cache:"no-store"}).then(r=>r.text()),
      fetch(MAP_CSV,{cache:"no-store"}).then(r=>r.text())
    ]);
  }catch(e){
    showBanner("Failed to fetch CSV. Check publish URLs and network.");
    return;
  }

  // Mapping
  mappingLatestByCard = {};
  activeMappedCards = new Set();
  pins = new Set();

  try{
    const mapRows = parseCSV(mapText);
    for(const r of mapRows){
      const card = (r.card_uid || "").trim();
      if(!card) continue;
      mappingLatestByCard[card] = r; // last row wins
    }
    for(const [card, r] of Object.entries(mappingLatestByCard)){
      const status = (r.status || "").toLowerCase();
      if(status === "active"){
        activeMappedCards.add(card);
        if((r.pin || "").trim()) pins.add((r.pin || "").trim());
      }
    }
  }catch(e){
    showBanner("Mapping CSV parse failed. Check headers and quoting.");
    return;
  }

  // Attendance
  try{
    attendance = parseCSV(attText);
  }catch(e){
    showBanner("Attendance CSV parse failed. Check headers and quoting.");
    return;
  }

  renderPresent();
  renderUnknownQueue();
}

function renderPresent(){
  // Presence is based ONLY on IN/OUT. UNKNOWN never affects presence.
  const latestInOutByCard = {};
  for(const e of attendance){
    const card = (e.card_uid || "").trim();
    if(!card) continue;
    const ev = (e.event || "").trim().toUpperCase();
    if(ev !== "IN" && ev !== "OUT") continue;
    latestInOutByCard[card] = e; // last row wins in CSV order
  }

  const present = Object.values(latestInOutByCard).filter(e => (e.event || "").toUpperCase() === "IN");
  document.getElementById("presentCount").textContent = present.length;

  const tbody = document.getElementById("presentTable");
  tbody.innerHTML = "";

  for(const e of present){
    const card = (e.card_uid || "").trim();
    const m = mappingLatestByCard[card];
    const ok = m && (m.status || "").toLowerCase() === "active";

    const tr = document.createElement("tr");
    if(!ok) tr.className = "unknown";

    tr.innerHTML = `
      <td>${ok ? (m.student_name || "—") : 'UNKNOWN <span class="badge bad">Not mapped</span>'}</td>
      <td>${ok ? (m.class || "—") : "—"}</td>
      <td>${e.Timestamp || "—"}</td>
      <td>${card}</td>
      <td><button onclick="openModal('${card}')">${ok ? "Edit" : "Register"}</button></td>
    `;
    tbody.appendChild(tr);
  }
}

function renderUnknownQueue(){
  // Queue should show latest UNKNOWN per card, but only if NOT mapped as active.
  const latestUnknownByCard = {};
  for(const e of attendance){
    const card = (e.card_uid || "").trim();
    if(!card) continue;
    const ev = (e.event || "").trim().toUpperCase();
    if(ev !== "UNKNOWN") continue;
    latestUnknownByCard[card] = e; // last row wins
  }

  const rows = Object.values(latestUnknownByCard)
    .filter(e => !activeMappedCards.has((e.card_uid || "").trim()))
    .slice(-100)
    .reverse();

  const tbody = document.getElementById("unknownTable");
  tbody.innerHTML = "";

  for(const e of rows){
    const card = (e.card_uid || "").trim();
    const tr = document.createElement("tr");
    tr.className = "unknown";
    tr.innerHTML = `
      <td>${e.Timestamp || "—"}</td>
      <td>${card}</td>
      <td>${e.device_id || "—"}</td>
      <td><button onclick="openModal('${card}')">Register</button></td>
    `;
    tbody.appendChild(tr);
  }
}

/* ===== Modal + Mapping Save (append-only) ===== */
function openModal(card){
  const m = mappingLatestByCard[card] || {};
  document.getElementById("modal").style.display = "flex";

  document.getElementById("m_card").value = card;
  document.getElementById("m_name").value = m.student_name || "";
  document.getElementById("m_email").value = m.student_email || "";
  document.getElementById("m_class").value = m.class || "";
  document.getElementById("m_status").value = (m.status || "active").toLowerCase() === "inactive" ? "inactive" : "active";
  document.getElementById("m_pin").value = (m.pin || "").trim();
  document.getElementById("m_note").value = "";

  document.getElementById("modalError").textContent = "";
  document.getElementById("modalSuccess").textContent = "";
}
function closeModal(){ document.getElementById("modal").style.display = "none"; }

function submitMapping(){
  const card = document.getElementById("m_card").value.trim();
  const name = document.getElementById("m_name").value.trim();
  const email = document.getElementById("m_email").value.trim();
  const cls = document.getElementById("m_class").value.trim();
  const status = document.getElementById("m_status").value.trim();
  const pin = document.getElementById("m_pin").value.trim();
  const note = document.getElementById("m_note").value.trim();

  const modalError = document.getElementById("modalError");
  const modalSuccess = document.getElementById("modalSuccess");
  modalError.textContent = "";
  modalSuccess.textContent = "";

  if(!card){ modalError.textContent = "Missing card UID."; return; }
  if(!name){ modalError.textContent = "Student name required."; return; }
  if(!cls){ modalError.textContent = "Class required."; return; }

  // PIN uniqueness among ACTIVE mappings (excluding same card)
  if(pin){
    const currentPin = ((mappingLatestByCard[card] || {}).pin || "").trim();
    if(pins.has(pin) && currentPin !== pin){
      modalError.textContent = "PIN already in use.";
      return;
    }
  }

  const d = new URLSearchParams();
  d.append(MAP.card, card);
  d.append(MAP.email, email);
  d.append(MAP.name, name);
  d.append(MAP.class, cls);
  d.append(MAP.status, status);
  d.append(MAP.pin, pin);
  d.append(MAP.note, note);
  d.append(MAP.mapped_by, localStorage.getItem("op") || "");
  d.append(MAP.schema, "v3");

  fetch(MAP_FORM, { method:"POST", mode:"no-cors", body:d });

  modalSuccess.textContent = "Saved. Click Refresh to update lists.";
}

document.getElementById("operator").value = localStorage.getItem("op") || "";
reloadAll();
</script>
</body>
</html>
