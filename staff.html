<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Junior Club â€“ Staff</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --navy:#102d69;
  --white:#ffffff;
  --border:#d0d7e2;
  --bg:#f6f8fb;
}

body{
  margin:0;
  font-family:"Open Sans",Arial,sans-serif;
  background:var(--bg);
  color:#102d69;
}

header{
  background:var(--navy);
  color:#fff;
  padding:16px 22px;
  font-weight:800;
  font-size:18px;
}

main{
  max-width:1100px;
  margin:24px auto;
  padding:0 20px;
}

.card{
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
  padding:16px;
  margin-bottom:20px;
}

h2{
  margin:0 0 12px;
  font-size:18px;
}

.count{
  font-size:48px;
  font-weight:800;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

th,td{
  padding:10px;
  border-bottom:1px solid var(--border);
  text-align:left;
}

th{
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.4px;
}
</style>
</head>

<body>

<header>Junior Club â€“ Staff View</header>

<main>

  <div class="card">
    <h2>Currently Present</h2>
    <div class="count" id="presentCount">â€“</div>
  </div>

  <div class="card">
    <h2>Whoâ€™s Here Now</h2>
    <table>
      <thead>
        <tr>
          <th>Card UID</th>
          <th>Time IN</th>
          <th>Device</th>
        </tr>
      </thead>
      <tbody id="presentTable"></tbody>
    </table>
  </div>

</main>

<script>
// ðŸ”’ READ-ONLY CSV FEED (LOCKED)
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?output=csv";

fetch(CSV_URL)
  .then(r => r.text())
  .then(csv => {
    const lines = csv.trim().split("\n");

    // Remove header row
    const rows = lines.slice(1);

    // Parse rows safely (no assumptions beyond column order)
    const events = rows.map(line => {
      const cols = line.split(",");
      return {
        timestamp: cols[0],
        card_uid: cols[1],
        event: cols[2],
        device_id: cols[3] || ""
      };
    });

    // Determine latest event per card_uid
    const latestByCard = {};
    events.forEach(e => {
      latestByCard[e.card_uid] = e;
    });

    // Filter current presence
    const present = Object.values(latestByCard)
      .filter(e => e.event === "IN");

    // Update count
    document.getElementById("presentCount").textContent = present.length;

    // Populate table
    const tbody = document.getElementById("presentTable");
    tbody.innerHTML = "";

    present.forEach(e => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${e.card_uid}</td>
        <td>${e.timestamp}</td>
        <td>${e.device_id || "-"}</td>
      `;
      tbody.appendChild(tr);
    });
  })
  .catch(err => {
    console.error("CSV load failed:", err);
    document.getElementById("presentCount").textContent = "Error";
  });
</script>

</body>
</html>
