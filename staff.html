<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Junior Club – Staff</title>

<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --navy:#102d69;
  --bg:#f6f8fb;
  --border:#d0d7e2;
  --warn:#fff7b2;
  --danger:#b00020;
  --ok:#0b6b2f;
}
body{margin:0;font-family:"Open Sans",Arial,sans-serif;background:var(--bg);color:#102d69;}
header{background:var(--navy);color:#fff;padding:14px 18px;}
header .top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;}
header input{padding:6px 8px;border-radius:6px;border:none;min-width:240px;}
header .meta{font-size:12px;opacity:.85;margin-top:6px;}
button{background:var(--navy);color:#fff;border:none;padding:6px 10px;border-radius:6px;font-weight:700;cursor:pointer;}
button.secondary{background:#fff;color:var(--navy);border:1px solid var(--border);}
main{max-width:1200px;margin:20px auto;padding:0 16px;}
.card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;}
.big{font-size:44px;font-weight:800;}
table{width:100%;border-collapse:collapse;}
th,td{padding:10px;border-bottom:1px solid var(--border);}
tr.unknown{background:var(--warn);}
.grid{display:grid;grid-template-columns:1fr;gap:16px;}
@media (min-width:980px){.grid{grid-template-columns:1fr 1fr;}}
.kv{display:grid;grid-template-columns:180px 1fr;gap:8px 12px;font-size:13px;}
.bad{color:var(--danger);font-weight:800;}
.good{color:var(--ok);font-weight:800;}
.mono{font-family:monospace;}
.small{font-size:12px;opacity:.85;}
</style>
</head>

<body>

<header>
  <div class="top">
    <strong>Junior Club – Staff</strong>
    <div>
      <input id="operator" placeholder="staff email">
      <button onclick="saveOperator()">Save</button>
      <button class="secondary" onclick="reloadAll()">Refresh</button>
    </div>
  </div>
  <div class="meta" id="updateStatus">Last updated: —</div>
</header>

<main>

<div class="card">
  <h2>Data Status</h2>
  <div class="kv">
    <div>Attendance rows</div><div id="dbgAttRows">—</div>
    <div>Mapping rows</div><div id="dbgMapRows">—</div>
    <div>Attendance headers</div><div id="dbgAttHeaders" class="mono">—</div>
    <div>Mapping headers</div><div id="dbgMapHeaders" class="mono">—</div>
    <div>Last error</div><div id="dbgError" class="bad">—</div>
  </div>
</div>

<div class="grid">

  <div>
    <div class="card">
      <h2>Currently Present</h2>
      <div class="big" id="presentCount">0</div>
    </div>

    <div class="card">
      <h2>Who’s Here Now</h2>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Class</th>
            <th>Time (Latest IN)</th>
            <th>Card</th>
          </tr>
        </thead>
        <tbody id="presentTable"></tbody>
      </table>
    </div>
  </div>

  <div>
    <div class="card">
      <h2>Unknown Cards Queue</h2>
      <table>
        <thead>
          <tr>
            <th>Time (Latest)</th>
            <th>Card</th>
          </tr>
        </thead>
        <tbody id="unknownTable"></tbody>
      </table>
    </div>
  </div>

</div>
</main>

<script>
const ATT_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=1075501813&single=true&output=csv";

const MAP_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=348834218&single=true&output=csv";

function saveOperator(){
  localStorage.setItem("op", operator.value);
}
operator.value = localStorage.getItem("op") || "";

function parseCSV(text){
  const rows = text.trim().split("\n").map(r=>r.split(","));
  const headers = rows.shift();
  return rows.map(r=>{
    const o={};
    headers.forEach((h,i)=>o[h.trim()]=r[i]?.trim());
    return o;
  });
}

async function reloadAll(){
  try{
    const [attText, mapText] = await Promise.all([
      fetch(ATT_CSV).then(r=>r.text()),
      fetch(MAP_CSV).then(r=>r.text())
    ]);

    const att = parseCSV(attText);
    const map = parseCSV(mapText);

    dbgAttRows.textContent = att.length;
    dbgMapRows.textContent = map.length;
    dbgAttHeaders.textContent = Object.keys(att[0]||{}).join(" | ");
    dbgMapHeaders.textContent = Object.keys(map[0]||{}).join(" | ");
    dbgError.textContent = "—";

    const mapping = {};
    map.forEach(r=>{
      mapping[r.card_uid] = r;
    });

    const latest = {};
    att.forEach(r=>{
      const t = Date.parse(r.Timestamp) || 0;
      if(!latest[r.card_uid] || t > latest[r.card_uid].t){
        latest[r.card_uid] = { ...r, t };
      }
    });

    const present=[], unknown=[];
    Object.values(latest).forEach(r=>{
      const m = mapping[r.card_uid];
      if(!m){
        unknown.push({ time:r.Timestamp, card:r.card_uid });
      } else if(r.event === "IN"){
        present.push({
          name:m.student_name,
          class:m.class,
          time:r.Timestamp,
          card:r.card_uid
        });
      }
    });

    presentTable.innerHTML = "";
    present.forEach(p=>{
      presentTable.insertAdjacentHTML("beforeend",`
        <tr><td>${p.name}</td><td>${p.class}</td><td>${p.time}</td><td>${p.card}</td></tr>
      `);
    });
    presentCount.textContent = present.length;

    unknownTable.innerHTML = "";
    unknown.forEach(u=>{
      unknownTable.insertAdjacentHTML("beforeend",`
        <tr class="unknown"><td>${u.time}</td><td>${u.card}</td></tr>
      `);
    });

    updateStatus.textContent = "Last updated: just now";
  }catch(e){
    dbgError.textContent = e.message;
  }
}

reloadAll();
</script>

</body>
</html>
