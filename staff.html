<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Junior Club – Staff</title>

<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --navy:#102d69;
  --bg:#f6f8fb;
  --border:#d0d7e2;
  --warn:#fff7b2;
  --green:#0b6b2f;
  --muted:#5b6b86;
  --danger:#b00020;
}

body{
  margin:0;
  font-family:"Open Sans",Arial,sans-serif;
  background:var(--bg);
  color:#102d69;
}

header{
  background:var(--navy);
  color:#fff;
  padding:14px 18px;
}

header .top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
}

header input, header select{
  padding:6px 8px;
  border-radius:6px;
  border:none;
  min-width:220px;
}

header .meta{
  font-size:12px;
  opacity:.95;
  margin-top:8px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
}

.meta .pill{
  display:inline-block;
  background:rgba(255,255,255,0.12);
  padding:4px 8px;
  border-radius:999px;
  font-weight:700;
}

.toolbar{
  margin-top:10px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
}

.toolbar .group{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}

.toggle{
  display:flex;
  align-items:center;
  gap:6px;
  background:rgba(255,255,255,0.10);
  padding:6px 10px;
  border-radius:999px;
  font-weight:700;
  font-size:12px;
  user-select:none;
}

.toggle input{ min-width:auto; }

button{
  background:var(--navy);
  color:#fff;
  border:none;
  padding:6px 10px;
  border-radius:6px;
  font-weight:800;
  cursor:pointer;
}

button.secondary{
  background:#fff;
  color:var(--navy);
  border:1px solid var(--border);
}

button.small{
  padding:5px 8px;
  font-size:12px;
  border-radius:6px;
}

a.smalllink{
  display:inline-block;
  padding:5px 8px;
  font-size:12px;
  border-radius:6px;
  font-weight:800;
  text-decoration:none;
  background:#fff;
  color:var(--navy);
  border:1px solid var(--border);
}

a.smalllink.disabled{
  opacity:.5;
  pointer-events:none;
}

main{
  max-width:1200px;
  margin:20px auto;
  padding:0 16px;
}

.card{
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
  padding:16px;
  margin-bottom:16px;
}

.big{
  font-size:48px;
  font-weight:800;
  color:var(--green);
}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:10px;
  border-bottom:1px solid var(--border);
  vertical-align:top;
}

tr.unknown{ background:var(--warn); }

.grid{
  display:grid;
  grid-template-columns:1fr;
  gap:16px;
}

@media (min-width:980px){
  .grid{ grid-template-columns:1fr 1fr; }
}

/* --- Debug hidden by default --- */
.debug{
  display:none;
  font-size:12px;
  opacity:.85;
  color:var(--muted);
}
.debug.show{ display:block; }
.toggle-debug{
  font-size:12px;
  cursor:pointer;
  opacity:.8;
  text-decoration:underline;
}

.smallmuted{ font-size:12px; opacity:.75; }

.badge-warn{ color:#000; background:var(--warn); border-radius:999px; padding:2px 8px; font-weight:800; }
.badge-danger{ color:#fff; background:var(--danger); border-radius:999px; padding:2px 8px; font-weight:800; }

@media print{
  header, .toggle-debug, #debugBox, #unknownCardHelp { display:none !important; }
  body{ background:#fff; }
  .card{ border:none; }
}
</style>
</head>

<body>

<header>
  <div class="top">
    <strong>Junior Club – Staff</strong>
    <div class="group">
      <input id="operator" placeholder="staff email">
      <button onclick="saveOperator()">Save</button>
      <button class="secondary" onclick="reloadAll()">Refresh</button>
    </div>
  </div>

  <div class="meta">
    <span class="pill" id="updateStatus">Last updated: —</span>
    <span class="pill" id="health">Data: —</span>
    <span class="pill" id="stale">Stale: —</span>
    <span class="pill badge-warn" id="cacheWarn" style="display:none;">⚠️ Google cache served an older snapshot — showing newest known data</span>
  </div>

  <div class="toolbar">
    <div class="group">
      <label class="toggle" title="Limits attendance view to scans from today (local time).">
        <input type="checkbox" id="todayOnly">
        Today-only
      </label>
    </div>

    <div class="group">
      <input id="search" placeholder="search name / class / card" style="min-width:260px;">
      <select id="classFilter" title="Filter by class" style="min-width:180px;">
        <option value="">All classes</option>
      </select>
      <select id="sortBy" title="Sort present list" style="min-width:200px;">
        <option value="time_desc">Sort: Latest time</option>
        <option value="name_asc">Sort: Name (A–Z)</option>
        <option value="class_asc">Sort: Class (A–Z)</option>
      </select>
    </div>

    <div class="group">
      <button class="secondary" onclick="printPage()">Print</button>
      <button class="secondary" onclick="copyPresent()">Copy list</button>
      <button class="secondary" onclick="exportPresentCsv()">Export CSV</button>
    </div>
  </div>
</header>

<main>

<div class="card">
  <h2>Currently Present</h2>
  <div class="big" id="presentCount">0</div>
  <div class="smallmuted">
    Latest scan per card (event = IN, mapping status = active)
  </div>
</div>

<div class="grid">

  <div>
    <div class="card">
      <h2>Who’s Here Now</h2>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Class</th>
            <th>Time (Latest IN)</th>
          </tr>
        </thead>
        <tbody id="presentTable"></tbody>
      </table>
    </div>
  </div>

  <div>
    <div class="card">
      <h2>Unknown Cards</h2>
      <div class="smallmuted" id="unknownCardHelp">
        Tip: Use <strong>Map</strong> to open the prefilled mapping form (if configured), or <strong>Copy</strong> to paste into the Mapping Form.
      </div>
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Card</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="unknownTable"></tbody>
      </table>
    </div>
  </div>

</div>

<div class="card">
  <div class="toggle-debug" onclick="toggleDebug()">Show diagnostics</div>
  <div class="debug" id="debugBox">
    Attendance rows: <span id="dbgAttRows">—</span><br>
    Mapping rows: <span id="dbgMapRows">—</span><br>
    Attendance headers: <span id="dbgAttHeaders"></span><br>
    Mapping headers: <span id="dbgMapHeaders"></span><br>
    Latest attendance timestamp: <span id="dbgLatestAttTs">—</span><br>
    Last error: <span id="dbgError"></span>
  </div>
</div>

</main>

<script>
/* ===========================
CONFIG
(ONLY changes: mapping form prefill config filled with your 9 questions)
=========================== */
const ATT_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=1075501813&single=true&output=csv";

const MAP_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=348834218&single=true&output=csv";

const MAP_FORM_PREFILL_BASE =
  "https://docs.google.com/forms/d/e/1FAIpQLSfzE9xEgS_MibTe-ZmcncKs617SxMauPRAMWZIZlsJoQG6qAQ/viewform?usp=pp_url";

/*
Your 9 questions:
1) card_uid    -> entry.1712147498
2) email       -> entry.1171642279
3) student_name-> entry.2022534068
4) class       -> entry.1723675198
5) status      -> entry.1124037588
6) pin         -> entry.352224440
7) note        -> entry.523442266
8) mapped_by   -> entry.1680238241
9) schema      -> entry.1809813215
*/
const MAP_ENTRY = {
  card_uid:  "entry.1712147498",
  mapped_by: "entry.1680238241",
  status:    "entry.1124037588",
  schema:    "entry.1809813215"
};
const MAP_DEFAULTS = { status: "active", schema: "v3" };

const STALE_WARN_MINUTES = 5;

/* ===========================
OPERATOR
=========================== */
function saveOperator(){ localStorage.setItem("op", operator.value); }
operator.value = localStorage.getItem("op") || "";

/* ===========================
PREFERENCES
=========================== */
function loadPrefBool(key, fallback){
  const v = localStorage.getItem(key);
  if (v === null) return fallback;
  return v === "1";
}
function savePrefBool(key, value){
  localStorage.setItem(key, value ? "1" : "0");
}
function loadPrefStr(key, fallback){
  const v = localStorage.getItem(key);
  return (v === null) ? fallback : v;
}
function savePrefStr(key, value){
  localStorage.setItem(key, value);
}

todayOnly.checked = loadPrefBool("todayOnly", true);
search.value = loadPrefStr("search", "");
sortBy.value = loadPrefStr("sortBy", "time_desc");
classFilter.value = loadPrefStr("classFilter", "");

/* ===========================
HEALTH / STATUS
=========================== */
let lastRefresh = 0;
let timer = null;
let lastError = "—";
let lastSyncAt = 0;

let lastAcceptedLatestAttTs = 0;
let lastAcceptedAttRows = 0;

function fmtTime(ts){
  if(!ts) return "—";
  return new Date(ts).toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
}

function startTimer(){
  if(timer) clearInterval(timer);
  timer = setInterval(()=>{
    if(!lastRefresh) return;
    const s = Math.floor((Date.now() - lastRefresh)/1000);
    updateStatus.textContent = `Last updated: ${s}s ago`;
  },1000);
}

function setHealth(mappingOk, attendanceOk){
  const m = mappingOk ? "✅" : "⏳";
  const a = attendanceOk ? "✅" : "⏳";
  const err = lastError && lastError !== "—" ? ` | Error: ${lastError}` : "";
  health.textContent = `Data: mapping ${m} attendance ${a} | Last sync: ${fmtTime(lastSyncAt)}${err}`;
}

function setStale(latestAttTs){
  if(!latestAttTs){
    stale.textContent = "Stale: —";
    return;
  }
  const ageMs = Date.now() - latestAttTs;
  const mins = Math.max(0, Math.floor(ageMs / 60000));
  const warn = mins >= STALE_WARN_MINUTES;

  stale.textContent = warn ? `Stale: ${mins}m ⚠️` : `Stale: ${mins}m`;
  stale.className = "pill" + (warn ? " badge-warn" : "");
}

function showCacheWarn(show){
  cacheWarn.style.display = show ? "inline-block" : "none";
}

/* ===========================
CSV PARSER (RFC4180-ish)
=========================== */
function parseCSV(text){
  const rows = [];
  let row = [];
  let field = "";
  let inQuotes = false;

  const pushField = () => { row.push(field); field = ""; };
  const pushRow = () => {
    if (row.length === 1 && row[0] === "" && rows.length === 0) return;
    rows.push(row);
    row = [];
  };

  const s = (text || "").replace(/\r\n/g, "\n").replace(/\r/g, "\n");

  for (let i = 0; i < s.length; i++){
    const c = s[i];

    if (c === '"'){
      const next = s[i + 1];
      if (inQuotes && next === '"'){
        field += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
      continue;
    }

    if (!inQuotes && c === ","){ pushField(); continue; }
    if (!inQuotes && c === "\n"){ pushField(); pushRow(); continue; }
    field += c;
  }

  pushField();
  pushRow();

  const headers = (rows.shift() || []).map(h => (h || "").trim());
  return rows
    .filter(r => r.some(v => (v || "").trim() !== ""))
    .map(r => {
      const o = {};
      headers.forEach((h, idx) => (o[h] = (r[idx] ?? "").trim()));
      return o;
    });
}

function parseEU(ts){
  if(!ts) return 0;
  const m = ts.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4}) (\d{1,2}):(\d{2}):(\d{2})$/);
  if(!m) return 0;
  return new Date(
    Number(m[3]),
    Number(m[2]) - 1,
    Number(m[1]),
    Number(m[4]),
    Number(m[5]),
    Number(m[6])
  ).getTime();
}

function startOfTodayLocalTs(){
  const d = new Date();
  d.setHours(0,0,0,0);
  return d.getTime();
}

/* ===========================
SAFE RENDERING
=========================== */
function clearNode(node){
  while (node.firstChild) node.removeChild(node.firstChild);
}

function addRow(tbody, cells, className){
  const tr = document.createElement("tr");
  if (className) tr.className = className;
  for (const val of cells){
    const td = document.createElement("td");
    td.textContent = val ?? "";
    tr.appendChild(td);
  }
  tbody.appendChild(tr);
  return tr;
}

/* ===========================
DATA + VIEW STATE
=========================== */
let presentAll = [];
let unknownAll = [];
let latestAttendanceTsAllTime = 0;

function normalizeStr(s){ return (s || "").toString().trim().toLowerCase(); }

function buildMappingPrefillUrl(cardUid){
  if (!MAP_FORM_PREFILL_BASE || !MAP_ENTRY.card_uid) return null;
  try{
    const url = new URL(MAP_FORM_PREFILL_BASE);
    url.searchParams.set(MAP_ENTRY.card_uid, cardUid);

    if (operator.value && MAP_ENTRY.mapped_by) url.searchParams.set(MAP_ENTRY.mapped_by, operator.value);
    if (MAP_ENTRY.status && MAP_DEFAULTS.status) url.searchParams.set(MAP_ENTRY.status, MAP_DEFAULTS.status);
    if (MAP_ENTRY.schema && MAP_DEFAULTS.schema) url.searchParams.set(MAP_ENTRY.schema, MAP_DEFAULTS.schema);

    return url.toString();
  }catch{
    return null;
  }
}

async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
  }catch{
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
  }
}

/* ===========================
FILTERS / SORT / EXPORT
=========================== */
function rebuildClassOptions(present){
  const wanted = classFilter.value;
  const classes = Array.from(new Set(present.map(p => p.class).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  clearNode(classFilter);
  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = "All classes";
  classFilter.appendChild(optAll);

  classes.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    classFilter.appendChild(opt);
  });

  classFilter.value = classes.includes(wanted) ? wanted : "";
  savePrefStr("classFilter", classFilter.value);
}

function applyFiltersAndRender(){
  const q = normalizeStr(search.value);
  const cls = classFilter.value;
  const sort = sortBy.value;

  let present = [...presentAll];
  let unknown = [...unknownAll];

  if (cls){
    present = present.filter(p => p.class === cls);
  }

  if (q){
    present = present.filter(p => {
      const hay = `${p.name} ${p.class} ${p.card}`.toLowerCase();
      return hay.includes(q);
    });
    unknown = unknown.filter(u => {
      const hay = `${u.card} ${u.time}`.toLowerCase();
      return hay.includes(q);
    });
  }

  if (sort === "name_asc"){
    present.sort((a,b)=>a.name.localeCompare(b.name));
  } else if (sort === "class_asc"){
    present.sort((a,b)=>(a.class||"").localeCompare(b.class||"") || a.name.localeCompare(b.name));
  } else {
    present.sort((a,b)=> (b._t - a._t));
  }

  clearNode(presentTable);
  present.forEach(p => addRow(presentTable, [p.name, p.class, p.time]));

  presentCount.textContent = String(present.length);

  clearNode(unknownTable);
  unknown.forEach(u=>{
    const tr = addRow(unknownTable, [u.time, u.card, ""], "unknown");

    const actionsTd = tr.lastChild;
    actionsTd.textContent = "";

    const mapUrl = buildMappingPrefillUrl(u.card);

    const mapA = document.createElement("a");
    mapA.className = "smalllink" + (mapUrl ? "" : " disabled");
    mapA.textContent = "Map";
    mapA.href = mapUrl || "#";
    mapA.target = "_blank";
    mapA.rel = "noopener";
    actionsTd.appendChild(mapA);

    const copyBtn = document.createElement("button");
    copyBtn.className = "secondary small";
    copyBtn.style.marginLeft = "8px";
    copyBtn.textContent = "Copy";
    copyBtn.onclick = () => copyText(u.card);
    actionsTd.appendChild(copyBtn);
  });

  rebuildClassOptions(presentAll);
}

function printPage(){ window.print(); }

async function copyPresent(){
  const lines = [];
  const q = normalizeStr(search.value);
  const cls = classFilter.value;

  let present = [...presentAll];
  if (cls) present = present.filter(p => p.class === cls);
  if (q) present = present.filter(p => (`${p.name} ${p.class} ${p.card}`.toLowerCase().includes(q)));
  present.sort((a,b)=> (b._t - a._t));

  lines.push(`Junior Club — Present (${present.length})`);
  lines.push(`Generated: ${new Date().toLocaleString("sv-SE")}`);
  lines.push("");

  present.forEach(p => lines.push(`${p.class}\t${p.name}\t${p.time}`));
  await copyText(lines.join("\n"));
}

function toCsv(rows, headers){
  const esc = (v) => {
    const s = (v ?? "").toString();
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  return [headers.join(","), ...rows.map(r => headers.map(h => esc(r[h])).join(","))].join("\n");
}

function exportPresentCsv(){
  const q = normalizeStr(search.value);
  const cls = classFilter.value;

  let present = [...presentAll];
  if (cls) present = present.filter(p => p.class === cls);
  if (q) present = present.filter(p => (`${p.name} ${p.class} ${p.card}`.toLowerCase().includes(q)));
  present.sort((a,b)=> (b._t - a._t));

  const rows = present.map(p => ({
    student_name: p.name,
    class: p.class,
    timestamp: p.time,
    card_uid: p.card
  }));

  const csv = toCsv(rows, ["student_name","class","timestamp","card_uid"]);
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  const yyyy = new Date().toISOString().slice(0,10);
  a.href = url;
  a.download = `juniorclub_present_${yyyy}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ===========================
MAIN LOAD
=========================== */
async function reloadAll(){
  let mappingOk = false;
  let attendanceOk = false;

  try{
    lastRefresh = Date.now();
    updateStatus.textContent = "Last updated: just now";
    startTimer();

    lastError = "—";
    showCacheWarn(false);
    setHealth(false, false);

    const attUrl = `${ATT_CSV}&_=${Date.now()}`;
    const mapUrl = `${MAP_CSV}&_=${Date.now()}`;

    const [attText, mapText] = await Promise.all([
      fetch(attUrl,{cache:"no-store"}).then(r=>r.text()),
      fetch(mapUrl,{cache:"no-store"}).then(r=>r.text())
    ]);

    const attAll = parseCSV(attText);
    const map = parseCSV(mapText);

    attendanceOk = true;
    mappingOk = true;
    lastSyncAt = Date.now();

    dbgAttRows.textContent = String(attAll.length);
    dbgMapRows.textContent = String(map.length);
    dbgAttHeaders.textContent = Object.keys(attAll[0]||{}).join(" | ");
    dbgMapHeaders.textContent = Object.keys(map[0]||{}).join(" | ");
    dbgError.textContent = "—";

    let fetchedLatestAttTs = 0;
    attAll.forEach(r => {
      const t = parseEU(r.Timestamp);
      if (t > fetchedLatestAttTs) fetchedLatestAttTs = t;
    });

    const gotClearlyOlderSnapshot =
      lastAcceptedLatestAttTs > 0 && (
        fetchedLatestAttTs === 0 || fetchedLatestAttTs + 2000 < lastAcceptedLatestAttTs
      );

    const gotRowCountDropWarning =
      lastAcceptedAttRows > 0 &&
      attAll.length + 2 < lastAcceptedAttRows &&
      fetchedLatestAttTs <= lastAcceptedLatestAttTs;

    if (gotClearlyOlderSnapshot || gotRowCountDropWarning) {
      lastError = "Received older published CSV snapshot (Google cache). Keeping newest view.";
      dbgError.textContent = lastError;
      showCacheWarn(true);

      setStale(lastAcceptedLatestAttTs);
      dbgLatestAttTs.textContent = lastAcceptedLatestAttTs
        ? new Date(lastAcceptedLatestAttTs).toLocaleString("sv-SE")
        : "—";

      setHealth(true, true);
      return;
    }

    lastAcceptedLatestAttTs = Math.max(lastAcceptedLatestAttTs, fetchedLatestAttTs);
    lastAcceptedAttRows = attAll.length;

    latestAttendanceTsAllTime = fetchedLatestAttTs;
    dbgLatestAttTs.textContent = latestAttendanceTsAllTime ? new Date(latestAttendanceTsAllTime).toLocaleString("sv-SE") : "—";
    setStale(latestAttendanceTsAllTime);

    const mapping = {};
    map.forEach(r=>{
      if(!r.card_uid) return;
      const t = parseEU(r.Timestamp);
      if(!mapping[r.card_uid] || t >= mapping[r.card_uid]._t){
        mapping[r.card_uid] = { ...r, _t:t };
      }
    });

    const useTodayOnly = todayOnly.checked;
    const dayStart = startOfTodayLocalTs();
    const att = useTodayOnly
      ? attAll.filter(r => parseEU(r.Timestamp) >= dayStart)
      : attAll;

    const latest = {};
    att.forEach(r=>{
      if(!r.card_uid) return;
      const t = parseEU(r.Timestamp);
      if(!latest[r.card_uid] || t >= latest[r.card_uid]._t){
        latest[r.card_uid] = { ...r, _t:t };
      }
    });

    const present = [];
    const unknown = [];

    Object.values(latest).forEach(r=>{
      const m = mapping[r.card_uid];

      if(!m){
        unknown.push({ time:r.Timestamp || "", card:r.card_uid || "" });
        return;
      }

      if(m.status === "active" && r.event === "IN"){
        present.push({
          name: m.student_name || "",
          class: m.class || "",
          time: r.Timestamp || "",
          card: r.card_uid || "",
          _t: r._t || 0
        });
      }
    });

    presentAll = present;
    unknownAll = unknown;

    applyFiltersAndRender();

  }catch(e){
    lastError = (e && e.message) ? e.message : String(e);
    dbgError.textContent = lastError;
  }finally{
    setHealth(mappingOk, attendanceOk);
  }
}

/* ===========================
EVENTS
=========================== */
todayOnly.addEventListener("change", ()=>{
  savePrefBool("todayOnly", todayOnly.checked);
  reloadAll();
});

search.addEventListener("input", ()=>{
  savePrefStr("search", search.value);
  applyFiltersAndRender();
});

classFilter.addEventListener("change", ()=>{
  savePrefStr("classFilter", classFilter.value);
  applyFiltersAndRender();
});

sortBy.addEventListener("change", ()=>{
  savePrefStr("sortBy", sortBy.value);
  applyFiltersAndRender();
});

function toggleDebug(){
  debugBox.classList.toggle("show");
}

/* ===========================
INIT
=========================== */
setHealth(false, false);
setStale(0);
showCacheWarn(false);
reloadAll();
setInterval(reloadAll, 20000);
</script>

</body>
</html>
