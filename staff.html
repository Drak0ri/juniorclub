<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Junior Club – Staff</title>

<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --navy:#102d69;
  --bg:#f6f8fb;
  --border:#d0d7e2;
  --warn:#fff7b2;
}
body{
  margin:0;
  font-family:"Open Sans",Arial,sans-serif;
  background:var(--bg);
  color:#102d69;
}
header{
  background:var(--navy);
  color:#fff;
  padding:14px 18px;
}
header .top{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header input{
  padding:6px 8px;
  border-radius:6px;
  border:none;
}
header .meta{
  font-size:12px;
  opacity:.85;
  margin-top:6px;
}
button{
  background:var(--navy);
  color:#fff;
  border:none;
  padding:6px 10px;
  border-radius:6px;
  font-weight:700;
  cursor:pointer;
}
button.secondary{
  background:#fff;
  color:var(--navy);
  border:1px solid var(--border);
}
main{
  max-width:1200px;
  margin:20px auto;
  padding:0 16px;
}
.card{
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
  padding:16px;
  margin-bottom:16px;
}
.big{
  font-size:44px;
  font-weight:800;
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  border-bottom:1px solid var(--border);
}
tr.unknown{
  background:var(--warn);
}
.grid{
  display:grid;
  grid-template-columns:1fr;
  gap:16px;
}
@media (min-width:980px){
  .grid{grid-template-columns:1fr 1fr;}
}
</style>
</head>

<body>

<header>
  <div class="top">
    <strong>Junior Club – Staff</strong>
    <div>
      <input id="operator" placeholder="staff email">
      <button onclick="saveOperator()">Save</button>
      <button class="secondary" onclick="reloadAll()">Refresh</button>
    </div>
  </div>
  <div class="meta" id="updateStatus">Last updated: —</div>
</header>

<main>
<div class="grid">

  <div>
    <div class="card">
      <h2>Currently Present</h2>
      <div class="big" id="presentCount">0</div>
      <div style="font-size:12px;opacity:.8">
        Latest scan per card decides presence (event = IN).
      </div>
    </div>

    <div class="card">
      <h2>Who’s Here Now</h2>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Class</th>
            <th>Time (Latest IN)</th>
            <th>Card</th>
          </tr>
        </thead>
        <tbody id="presentTable"></tbody>
      </table>
    </div>
  </div>

  <div>
    <div class="card">
      <h2>Unknown Cards Queue</h2>
      <table>
        <thead>
          <tr>
            <th>Time (Latest)</th>
            <th>Card</th>
          </tr>
        </thead>
        <tbody id="unknownTable"></tbody>
      </table>
    </div>
  </div>

</div>
</main>

<script>
/* ===== CONFIG – MATCHES YOUR SHEET EXACTLY ===== */
const ATT_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=1075501813&single=true&output=csv";

const MAP_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=348834218&single=true&output=csv";
/* ============================================= */

let lastRefresh=null;
let timer=null;

function saveOperator(){
  localStorage.setItem("op", operator.value);
}

operator.addEventListener("blur", saveOperator);
operator.addEventListener("change", saveOperator);

function startTimer(){
  if(timer) clearInterval(timer);
  timer=setInterval(()=>{
    if(!lastRefresh) return;
    const s=Math.floor((Date.now()-lastRefresh)/1000);
    updateStatus.textContent=
      `Last updated: ${s} second${s!==1?"s":""} ago`;
  },1000);
}

/* CSV parser */
function parseCSV(text){
  const rows=[],row=[];
  let cur="",q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i],n=text[i+1];
    if(c=='"'&&q&&n=='"'){cur+='"';i++;continue;}
    if(c=='"'){q=!q;continue;}
    if(c==","&&!q){row.push(cur);cur="";continue;}
    if((c=="\n"||c=="\r")&&!q){
      if(c=="\r"&&n=="\n")i++;
      row.push(cur);
      rows.push([...row]);
      row.length=0;
      cur="";
      continue;
    }
    cur+=c;
  }
  if(cur||row.length){row.push(cur);rows.push([...row]);}
  const headers=rows.shift();
  return rows.map(r=>{
    const o={};
    headers.forEach((h,i)=>o[h]=r[i]?.trim());
    return o;
  });
}

async function reloadAll(){
  lastRefresh=Date.now();
  updateStatus.textContent="Last updated: just now";
  startTimer();

  const [att,map]=await Promise.all([
    fetch(ATT_CSV+"&t="+Date.now()).then(r=>r.text()).then(parseCSV),
    fetch(MAP_CSV+"&t="+Date.now()).then(r=>r.text()).then(parseCSV)
  ]);

  /* Latest mapping per card */
  const mapping={};
  map.forEach(r=>{
    if(!r.card_uid) return;
    const t=Date.parse(r.Timestamp)||0;
    if(!mapping[r.card_uid] || t>mapping[r.card_uid]._t){
      mapping[r.card_uid]={...r,_t:t};
    }
  });

  /* Latest scan per card */
  const latestScan={};
  att.forEach(r=>{
    if(!r.card_uid) return;
    const t=Date.parse(r.Timestamp)||0;
    if(!latestScan[r.card_uid] || t>latestScan[r.card_uid]._t){
      latestScan[r.card_uid]={...r,_t:t};
    }
  });

  const present=[],unknown=[];

  Object.values(latestScan).forEach(r=>{
    const m=mapping[r.card_uid];
    const name=m?.student_name || "";
    const cls=m?.class || "";

    if(!name){
      unknown.push(r);
      return;
    }

    if(r.event === "IN"){
      present.push({
        name,
        class: cls,
        time: r.Timestamp,
        card: r.card_uid
      });
    }
  });

  renderPresent(present);
  renderUnknown(unknown);
}

function renderPresent(list){
  presentTable.innerHTML="";
  list.forEach(r=>{
    presentTable.insertAdjacentHTML("beforeend",`
      <tr>
        <td>${r.name}</td>
        <td>${r.class}</td>
        <td>${r.time}</td>
        <td>${r.card}</td>
      </tr>
    `);
  });
  presentCount.textContent=list.length;
}

function renderUnknown(list){
  unknownTable.innerHTML="";
  list.forEach(r=>{
    unknownTable.insertAdjacentHTML("beforeend",`
      <tr class="unknown">
        <td>${r.Timestamp}</td>
        <td>${r.card_uid}</td>
      </tr>
    `);
  });
}

operator.value=localStorage.getItem("op")||"";
reloadAll();
setInterval(reloadAll,20000);
</script>

</body>
</html>
