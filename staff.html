<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Junior Club – Staff</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --navy:#102d69;
  --bg:#f6f8fb;
  --white:#ffffff;
  --border:#d0d7e2;
  --warn:#fff7b2;
  --muted:#eef2f8;
  --danger:#b00020;
  --ok:#0b6b2f;
}
body{
  margin:0;
  font-family:"Open Sans",Arial,sans-serif;
  background:var(--bg);
  color:#102d69;
}
header{
  background:var(--navy);
  color:#fff;
  padding:14px 18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header input{
  padding:6px 8px;
  border-radius:6px;
  border:none;
}
button{
  background:var(--navy);
  color:#fff;
  border:none;
  padding:6px 10px;
  border-radius:6px;
  font-weight:700;
  cursor:pointer;
}
button.secondary{
  background:#fff;
  color:var(--navy);
  border:1px solid var(--border);
}
main{
  max-width:1200px;
  margin:20px auto;
  padding:0 16px;
}
.card{
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
  padding:16px;
  margin-bottom:16px;
}
h2{ margin:0 0 12px; }
.big{ font-size:44px; font-weight:800; }
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
th,td{
  padding:10px;
  border-bottom:1px solid var(--border);
  text-align:left;
}
tr.unknown{ background:var(--warn); }
.badge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-size:12px;
  font-weight:800;
}
.badge.ok{ color:var(--ok); }
.badge.bad{ color:var(--danger); }
</style>
</head>

<body>

<header>
  <strong>Junior Club – Staff</strong>
  <div>
    <input id="operator" placeholder="staff email">
    <button onclick="saveOperator()">Save</button>
    <button class="secondary" onclick="reloadAll()">Refresh</button>
  </div>
</header>

<main>

<div class="card">
  <h2>Currently Present</h2>
  <div class="big" id="presentCount">–</div>
</div>

<div class="card">
  <h2>Who’s Here Now</h2>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Class</th>
        <th>Time IN</th>
        <th>Card UID</th>
        <th>Method</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="presentTable"></tbody>
  </table>
</div>

</main>

<script>
/* ================= CONFIG ================= */

const ATT_CSV =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=1075501813&single=true&output=csv";

const MAP_CSV =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=348834218&single=true&output=csv";

/* ========================================= */

let mappingByCard = {};
let attendance = [];

function parseCSV(text){
  const lines = text.trim().split("\n");
  const headers = splitCSVLine(lines[0]);
  const rows = lines.slice(1).map(l => {
    const vals = splitCSVLine(l);
    const obj = {};
    headers.forEach((h,i)=> obj[h.trim()] = vals[i]?.trim() || "");
    return obj;
  });
  return rows;
}

function splitCSVLine(line){
  const out=[]; let cur=""; let q=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c==='"'){
      if(q && line[i+1]==='"'){ cur+='"'; i++; }
      else q=!q;
    } else if(c===',' && !q){
      out.push(cur); cur="";
    } else cur+=c;
  }
  out.push(cur);
  return out;
}

function saveOperator(){
  localStorage.setItem("jc_operator",document.getElementById("operator").value.trim());
}

function loadOperator(){
  document.getElementById("operator").value =
    localStorage.getItem("jc_operator") || "";
}

async function reloadAll(){
  const [attText,mapText] = await Promise.all([
    fetch(ATT_CSV,{cache:"no-store"}).then(r=>r.text()),
    fetch(MAP_CSV,{cache:"no-store"}).then(r=>r.text())
  ]);

  loadMapping(mapText);
  loadAttendance(attText);
  renderPresent();
}

function loadMapping(csv){
  const rows = parseCSV(csv);
  mappingByCard = {};
  rows.forEach(r=>{
    if(!r.card_uid) return;
    mappingByCard[r.card_uid] = {
      name: r.student_name,
      class: r.class,
      status: (r.status||"").toLowerCase(),
      pin: r.pin || ""
    };
  });
}

function loadAttendance(csv){
  attendance = parseCSV(csv);
}

function renderPresent(){
  const latest = {};
  attendance.forEach(e=>{
    if(!e.card_uid) return;
    latest[e.card_uid] = e;
  });

  const present = Object.values(latest).filter(e=>e.event==="IN");
  document.getElementById("presentCount").textContent = present.length;

  const tbody = document.getElementById("presentTable");
  tbody.innerHTML = "";

  present.forEach(e=>{
    const m = mappingByCard[e.card_uid];
    const ok = m && m.status==="active";

    const tr=document.createElement("tr");
    if(!ok) tr.className="unknown";

    tr.innerHTML=`
      <td>${ok ? m.name : "UNKNOWN"}
        <span class="badge ${ok?"ok":"bad"}">${ok?"Active":"Unknown / Inactive"}</span>
      </td>
      <td>${ok ? m.class : "-"}</td>
      <td>${e.Timestamp}</td>
      <td>${e.card_uid}</td>
      <td>${e.method || "-"}</td>
      <td><button>Register</button></td>
    `;
    tbody.appendChild(tr);
  });
}

loadOperator();
reloadAll();
</script>

</body>
</html>
