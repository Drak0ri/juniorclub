<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Junior Club – Staff</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --navy:#102d69;
  --bg:#f6f8fb;
  --white:#ffffff;
  --border:#d0d7e2;
  --warn:#fff7b2;
  --muted:#e9edf4;
}

body{
  margin:0;
  font-family:"Open Sans",Arial,sans-serif;
  background:var(--bg);
  color:#102d69;
}

header{
  background:var(--navy);
  color:#fff;
  padding:16px 22px;
  font-weight:800;
  font-size:18px;
}

main{
  max-width:1200px;
  margin:24px auto;
  padding:0 20px;
}

.tabs{
  display:flex;
  gap:10px;
  margin-bottom:20px;
}

.tabs button{
  padding:8px 14px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fff;
  font-weight:700;
  cursor:pointer;
}

.tabs button.active{
  background:var(--navy);
  color:#fff;
}

.card{
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
  padding:16px;
  margin-bottom:20px;
}

h2{ margin:0 0 12px; }

.count{
  font-size:48px;
  font-weight:800;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

th,td{
  padding:10px;
  border-bottom:1px solid var(--border);
  text-align:left;
}

th{
  font-size:12px;
  text-transform:uppercase;
}

tr.unknown{ background:var(--warn); }
tr.inactive{ background:var(--muted); }

.action-btn{
  padding:6px 10px;
  border-radius:6px;
  font-weight:700;
  border:none;
  cursor:pointer;
  background:var(--navy);
  color:#fff;
}
</style>
</head>

<body>

<header>Junior Club – Staff</header>

<main>

<div class="tabs">
  <button class="active" data-tab="present">Who’s Here</button>
  <button data-tab="mapping">Student Mapping</button>
</div>

<!-- PRESENT TAB -->
<div class="tab" id="presentTab">

  <div class="card">
    <h2>Currently Present</h2>
    <div class="count" id="presentCount">–</div>
  </div>

  <div class="card">
    <h2>Who’s Here Now</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Class</th>
          <th>Time IN</th>
          <th>Card UID</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="presentTable"></tbody>
    </table>
  </div>

</div>

<!-- MAPPING TAB -->
<div class="tab" id="mappingTab" style="display:none;">

  <div class="card">
    <h2>Student Card Mapping</h2>
    <table>
      <thead>
        <tr>
          <th>Card UID</th>
          <th>Name</th>
          <th>Class</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="mappingTable"></tbody>
    </table>
  </div>

</div>

</main>

<script>
/* ================= CONFIG ================= */

const ATTENDANCE_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?output=csv";

const MAPPING_CSV =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=1898379100&single=true&output=csv";

const MAPPING_FORM =
  "https://docs.google.com/forms/d/e/1FAIpQLSfzE9xEgS_MibTe-ZmcncKs617SxMauPRAMWZIZlsJoQG6qAQ/viewform";

const ENTRY_CARD_UID = "entry.1712147498";
const ENTRY_STATUS   = "entry.1124037588";

/* ========================================== */

Promise.all([
  fetch(ATTENDANCE_CSV).then(r=>r.text()),
  fetch(MAPPING_CSV).then(r=>r.text())
]).then(([attendanceCSV,mappingCSV])=>{

  /* Parse mapping – last row wins */
  const mappingRows = mappingCSV.trim().split("\n").slice(1);
  const mapping = {};
  mappingRows.forEach(r=>{
    const [card,email,name,cls,status] = r.split(",");
    mapping[card] = { email,name,cls,status };
  });

  /* Build present list */
  const logRows = attendanceCSV.trim().split("\n").slice(1);
  const latest = {};
  logRows.forEach(r=>{
    const [ts,card,event] = r.split(",");
    latest[card] = { ts,card,event };
  });

  const present = Object.values(latest).filter(e=>e.event==="IN");
  document.getElementById("presentCount").textContent = present.length;

  const presentTable = document.getElementById("presentTable");
  present.forEach(e=>{
    const m = mapping[e.card];
    const tr = document.createElement("tr");
    if(!m || m.status!=="active") tr.className="unknown";

    const regUrl =
      `${MAPPING_FORM}?usp=pp_url&${ENTRY_CARD_UID}=${encodeURIComponent(e.card)}`;

    tr.innerHTML = `
      <td>${m ? m.name : "UNKNOWN"}</td>
      <td>${m ? m.cls : "-"}</td>
      <td>${e.ts}</td>
      <td>${e.card}</td>
      <td>${!m || m.status!=="active" ? `<button class="action-btn" onclick="window.open('${regUrl}','_blank')">Register</button>` : ""}</td>
    `;
    presentTable.appendChild(tr);
  });

  /* Mapping table */
  const mapTable = document.getElementById("mappingTable");
  Object.entries(mapping).forEach(([card,m])=>{
    const tr = document.createElement("tr");
    if(m.status!=="active") tr.className="inactive";

    const deactivateUrl =
      `${MAPPING_FORM}?usp=pp_url&${ENTRY_CARD_UID}=${encodeURIComponent(card)}&${ENTRY_STATUS}=inactive`;

    tr.innerHTML = `
      <td>${card}</td>
      <td>${m.name}</td>
      <td>${m.cls}</td>
      <td>${m.status}</td>
      <td>
        ${m.status==="active"
          ? `<button class="action-btn" onclick="window.open('${deactivateUrl}','_blank')">Deactivate</button>`
          : ""
        }
      </td>
    `;
    mapTable.appendChild(tr);
  });
});

/* Tabs */
document.querySelectorAll(".tabs button").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");

    document.getElementById("presentTab").style.display =
      btn.dataset.tab==="present" ? "" : "none";
    document.getElementById("mappingTab").style.display =
      btn.dataset.tab==="mapping" ? "" : "none";
  });
});
</script>

</body>
</html>
