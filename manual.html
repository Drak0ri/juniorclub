<!-- /manual.html (v3.2 - consistent blue design) -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manual Check-In/Out ‚Äì Junior Club</title>
<link rel="icon" href="./ies.ico" type="image/x-icon">
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --navy:#102d69;
  --bg:#102d69;
  --card:rgba(255,255,255,0.08);
  --card-solid:#1a3a7a;
  --text:#ffffff;
  --muted:rgba(255,255,255,0.7);
  --border:rgba(255,255,255,0.15);
  --green-bg:#d9f2c7;
  --green-text:#0b6b2f;
  --red-bg:#ffd6d6;
  --red-text:#b00020;
  --yellow-bg:#fff3b0;
}

*{box-sizing:border-box;}
body{margin:0;font-family:"Open Sans",Arial,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;}

header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;flex-wrap:wrap;gap:12px;border-bottom:1px solid var(--border);}
header .left{display:flex;align-items:center;gap:12px;}
header .left img{height:34px;}
header .left span{font-weight:800;font-size:18px;}
header .right{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
header .clock{font-weight:800;font-size:18px;}

.toolbar{padding:10px 18px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:rgba(255,255,255,0.03);}
.toolbar .group{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.toolbar input,.toolbar select{padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:rgba(255,255,255,0.1);color:#fff;font-family:inherit;}
.toolbar input::placeholder{color:var(--muted);}
.operator-badge{background:rgba(255,255,255,0.12);padding:5px 10px;border-radius:999px;font-weight:700;font-size:12px;border:1px solid var(--border);}

button{background:rgba(255,255,255,0.12);color:#fff;border:1px solid var(--border);padding:8px 12px;border-radius:8px;font-weight:800;cursor:pointer;font-family:inherit;}
button:hover{background:rgba(255,255,255,0.2);}
button.primary{background:var(--navy);border-color:var(--navy);}
button.danger{background:var(--red-text);border-color:var(--red-text);}
button.success{background:var(--green-text);border-color:var(--green-text);}

main{flex:1;padding:16px 18px 80px;}

.stats{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px;}
.stat{background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:10px;padding:12px 16px;min-width:100px;}
.stat-label{font-size:11px;font-weight:800;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.stat-value{font-size:28px;font-weight:800;}
.stat.in .stat-value{color:var(--green-bg);}
.stat.out .stat-value{color:var(--red-bg);}

.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;}
.card h2{margin:0 0 12px;font-size:16px;font-weight:800;}

.just-left-card{background:rgba(176,0,32,0.1);border:1px solid rgba(176,0,32,0.3);}
.just-left-card h2{color:var(--red-bg);}
.left-list{display:flex;flex-wrap:wrap;gap:8px;}
.left-chip{background:rgba(176,0,32,0.2);border:1px solid rgba(176,0,32,0.3);padding:6px 12px;border-radius:8px;font-weight:700;font-size:13px;color:var(--red-bg);}

table{width:100%;border-collapse:collapse;}
th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;}
th{font-size:11px;text-transform:uppercase;color:var(--muted);font-weight:800;}
tr:hover{background:rgba(255,255,255,0.03);}
tr.temp{background:rgba(255,243,176,0.08);}

.status-in{color:var(--green-text);background:var(--green-bg);padding:3px 8px;border-radius:999px;font-size:11px;font-weight:800;}
.status-out{color:var(--red-text);background:var(--red-bg);padding:3px 8px;border-radius:999px;font-size:11px;font-weight:800;}

.toggle-btn{padding:6px 14px;border-radius:6px;font-weight:800;font-size:12px;cursor:pointer;border:none;}
.toggle-btn.in{background:var(--green-text);color:#fff;}
.toggle-btn.out{background:var(--red-text);color:#fff;}
.remove-btn{background:transparent;border:1px solid var(--border);color:var(--muted);padding:5px 8px;border-radius:6px;font-size:11px;margin-left:6px;cursor:pointer;}

.empty{text-align:center;padding:30px;color:var(--muted);}
.empty-icon{font-size:32px;margin-bottom:8px;}
.empty-text{font-weight:700;}

footer{padding:10px 18px;font-size:12px;color:var(--muted);display:flex;justify-content:space-between;border-top:1px solid var(--border);}

.banner{position:fixed;left:12px;right:12px;bottom:12px;background:rgba(255,255,255,0.12);border:1px solid var(--border);color:var(--muted);border-radius:10px;padding:6px 12px;display:none;gap:8px;font-size:11px;align-items:center;justify-content:space-between;box-shadow:none;z-index:9998;font-size:12px;color:#000;}
.banner.show{display:flex;}
.banner strong{color:#fff;font-weight:700;font-size:11px;}
.banner button{padding:5px 10px;font-size:11px;background:#102d69;color:#fff;border:none;border-radius:6px;cursor:pointer;}

/* PIN Gate */
.pin-gate{position:fixed;inset:0;background:var(--bg);display:none;align-items:center;justify-content:center;z-index:10000;}
.pin-gate.show{display:flex;}
.pin-box{background:var(--card-solid);border:1px solid var(--border);border-radius:16px;padding:24px;width:min(400px,90vw);text-align:center;}
.pin-box h2{margin:0 0 16px;font-size:20px;}
.pin-box input{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,0.1);color:#fff;font-size:18px;text-align:center;font-family:inherit;margin-bottom:12px;}
.pin-box .error-msg{color:var(--red-bg);font-size:13px;font-weight:700;margin-bottom:10px;}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999;}
.modal-overlay.show{display:flex;}
.modal{width:min(500px,96vw);background:var(--card-solid);border:1px solid var(--border);border-radius:14px;overflow:hidden;}
.modal-header{background:var(--navy);color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;font-weight:800;}
.modal-body{padding:14px;display:grid;gap:12px;}
.field label{display:block;font-size:11px;font-weight:800;margin-bottom:4px;color:var(--muted);text-transform:uppercase;}
.field input,.field select{width:100%;border:1px solid var(--border);border-radius:8px;padding:8px 10px;font-family:inherit;font-size:14px;background:rgba(255,255,255,0.1);color:#fff;}
.field input::placeholder{color:var(--muted);}
.modal-foot{padding:12px 14px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;}

.toast{position:fixed;right:16px;bottom:16px;background:var(--green-bg);color:var(--green-text);border-radius:10px;padding:10px 14px;font-weight:800;font-size:13px;opacity:0;transform:translateY(10px);pointer-events:none;transition:all .18s ease;z-index:10000;}
.toast.show{opacity:1;transform:translateY(0);}
.toast.error{background:var(--red-bg);color:var(--red-text);}
</style>
</head>
<body>

<div class="pin-gate" id="pinGate">
<div class="pin-box">
<h2>üîí Staff Access</h2>
<input type="password" id="pinInput" placeholder="Enter PIN" autocomplete="off">
<div id="pinError"></div>
<button class="primary" onclick="checkPin()">Enter</button>
</div>
</div>

<div id="app" style="display:none;flex-direction:column;min-height:100vh;">

<header>
<div class="left">
<a href="./index.html"><img src="./logo-negative.png" alt="IES Logo"></a>
<span>Manual Check-In/Out</span>
</div>
<div class="right">
<span class="clock" id="clock">--:--</span>
<button onclick="logout()">üîí Logout</button>
</div>
</header>

<div class="toolbar">
<div class="group">
<input type="text" id="searchBox" placeholder="Search name or class...">
<select id="classFilter"><option value="">All classes</option></select>
<span class="operator-badge">Operator: <span id="operatorName">‚Äî</span></span>
</div>
<div class="group">
<button onclick="openAddTempModal()">+ Add Temporary Student</button>
<button class="danger" onclick="markAllOut()">Mark All OUT</button>
<button onclick="manualRefresh()">üîÑ Refresh</button>
</div>
</div>

<main>

<div class="stats">
<div class="stat in"><div class="stat-label">Currently In</div><div class="stat-value" id="statIn">0</div></div>
<div class="stat out"><div class="stat-label">Currently Out</div><div class="stat-value" id="statOut">0</div></div>
<div class="stat"><div class="stat-label">Total Students</div><div class="stat-value" id="statTotal">0</div></div>
</div>

<div class="card just-left-card" id="justLeftCard" style="display:none;">
<h2>Just left (last 5 minutes)</h2>
<div class="left-list" id="justLeftList"></div>
</div>

<div class="card">
<h2>All Students</h2>
<table>
<thead><tr><th>Name</th><th>Class</th><th>Status</th><th>Actions</th></tr></thead>
<tbody id="studentTable"></tbody>
</table>
</div>

</main>

<footer>
<span>Junior Club ‚Äì Manual Check-In/Out</span>
<span>Last updated: <span id="lastUpdate">‚Äî</span></span>
</footer>

</div>

<div class="banner" id="banner">
<div><strong id="bannerTitle">‚ö†Ô∏è Data delay</strong> <span id="bannerMsg">‚Äî</span></div>
<button onclick="hideBanner()">Dismiss</button>
</div>

<div class="modal-overlay" id="addTempModal">
<div class="modal">
<div class="modal-header">
<span>Add Temporary Student</span>
<button onclick="closeAddTempModal()">Close</button>
</div>
<div class="modal-body">
<div class="field"><label>Student Name</label><input type="text" id="tempName" placeholder="First Last"></div>
<div class="field"><label>Class</label><select id="tempClass"></select></div>
<div class="field"><label>Note (optional)</label><input type="text" id="tempNote" placeholder="e.g. Visitor"></div>
</div>
<div class="modal-foot">
<button onclick="closeAddTempModal()">Cancel</button>
<button class="success" onclick="submitAddTemp()">Add & Check In</button>
</div>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
const STAFF_PIN = "1234";
const DEVICE_ID = "Manual-1";
const CLUB_ID = "IESV_JuniorClub";
const SCHEMA_VERSION = "v3";
const CLASSES = ["4A","4B","4C","5A","5B","5C","6A","6B","6C","7A","7B","7C","8A","8B","8C","9A","9B","9C"];
const JUST_LEFT_MS = 5 * 60 * 1000;

const ATT_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSf5zEJQa4T8tRgKOQ2DQ80OqCkrElNcx5X_5Udg0GJ4vyvpRQ/formResponse";
const ATT = { card_uid:"entry.1104238975", event:"entry.1735508359", device_id:"entry.452811867", method:"entry.1237226768", operator:"entry.1642343573", note:"entry.1538254700", club_id:"entry.164839595", schema_version:"entry.2138280654" };

const MAPPING_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=348834218&single=true&output=csv";
const ATT_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=1075501813&single=true&output=csv";

const TEMP_STORAGE_KEY = "juniorclub_temp_students", OPERATOR_STORAGE_KEY = "juniorclub_operator", PIN_STORAGE_KEY = "juniorclub_manual_pin_ok", LOCAL_OVERRIDES_KEY = "juniorclub_local_overrides";
const LOCAL_SCANS_KEY = "juniorclub_local_scans_v1";
const LOCAL_REGISTERED_KEY = "juniorclub_local_registered_v1";

let students = [], attendanceState = {}, tempStudents = [], operator = "", localOverrides = {}, justLeftStudents = [];
let autoLogoutTimer = null;

function resetAutoLogout(){
  if(autoLogoutTimer) clearTimeout(autoLogoutTimer);
  autoLogoutTimer = setTimeout(() => {
    localStorage.removeItem(PIN_STORAGE_KEY);
    location.reload();
  }, 2 * 60 * 1000); // 2 minutes
}

function checkPin(){
  const input = document.getElementById("pinInput").value.trim();
  if(input === STAFF_PIN){ 
    localStorage.setItem(PIN_STORAGE_KEY, "1"); 
    document.getElementById("pinGate").style.display = "none"; 
    document.getElementById("app").style.display = "flex"; 
    resetAutoLogout();
    init(); 
  }
  else { document.getElementById("pinError").innerHTML = '<div class="error-msg">Incorrect PIN.</div>'; }
}

function logout(){ if(confirm("Logout?")){ localStorage.removeItem(PIN_STORAGE_KEY); location.reload(); } }

if(localStorage.getItem(PIN_STORAGE_KEY) === "1"){ 
  document.getElementById("pinGate").style.display = "none"; 
  document.getElementById("app").style.display = "flex"; 
  document.readyState === "loading" ? document.addEventListener("DOMContentLoaded", init) : init(); 
  resetAutoLogout();
}
else { document.getElementById("pinGate").style.display = "flex"; }

// Reset auto logout on any activity
["click","keydown","touchstart","scroll"].forEach(evt => {
  document.addEventListener(evt, resetAutoLogout, { passive: true });
});

document.getElementById("pinInput")?.addEventListener("keydown", e => { if(e.key === "Enter") checkPin(); });

function updateClock(){ const el = document.getElementById("clock"); if(el) el.textContent = new Date().toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"}); }
setInterval(updateClock, 1000); updateClock();

function splitCSVLine(line){ const out = [], len = line.length; let cur = "", q = false; for(let i = 0; i < len; i++){ const c = line[i]; if(c === '"'){ q = !q; continue; } if(c === ',' && !q){ out.push(cur); cur = ""; continue; } cur += c; } out.push(cur); return out.map(s => s.trim()); }
function parseCSV(text){ const lines = text.trim().split("\n"); if(lines.length < 2) return []; const headers = splitCSVLine(lines[0]); return lines.slice(1).map(l => { const v = splitCSVLine(l), o = {}; headers.forEach((h, i) => o[h] = v[i] || ""); return o; }); }
function parseEU(ts){ const m = ts && ts.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4}) (\d{1,2}):(\d{2}):(\d{2})$/); if(!m) return 0; return new Date(+m[3], m[2]-1, +m[1], +m[4], +m[5], +m[6]).getTime(); }
function showToast(msg, error = false){ const toast = document.getElementById("toast"); toast.textContent = msg; toast.classList.toggle("error", error); toast.classList.add("show"); setTimeout(() => toast.classList.remove("show"), 3000); }
function clearNode(node){ while(node.firstChild) node.removeChild(node.firstChild); }
function generateTempCardUID(){ return `TEMP_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`; }
function showBanner(title, msg){ document.getElementById("bannerTitle").textContent = "‚ö†Ô∏è " + title; document.getElementById("bannerMsg").textContent = msg; document.getElementById("banner").classList.add("show"); }
function hideBanner(){ document.getElementById("banner").classList.remove("show"); }

function loadLocalOverrides(){ try{ const raw = localStorage.getItem(LOCAL_OVERRIDES_KEY); return raw ? JSON.parse(raw) : {}; }catch{ return {}; } }
function saveLocalOverride(card, state){ localOverrides[card] = {state, timestamp: Date.now()}; try{ localStorage.setItem(LOCAL_OVERRIDES_KEY, JSON.stringify(localOverrides)); }catch{} }
function clearOldOverrides(){ const now = Date.now(); Object.keys(localOverrides).forEach(card => { if(now - localOverrides[card].timestamp > 300000) delete localOverrides[card]; }); try{ localStorage.setItem(LOCAL_OVERRIDES_KEY, JSON.stringify(localOverrides)); }catch{} }

function loadLocalScans(){ try { const raw = localStorage.getItem(LOCAL_SCANS_KEY); return raw ? JSON.parse(raw) : {}; } catch { return {}; } }
function loadLocalRegistered(){ try { const raw = localStorage.getItem(LOCAL_REGISTERED_KEY); return raw ? JSON.parse(raw) : {}; } catch { return {}; } }

function recordLocalScan(card, event, studentName, studentClass){
  const scans = loadLocalScans();
  const now = Date.now();
  const cutoff = now - (24 * 60 * 60 * 1000);
  for (const [key, scan] of Object.entries(scans)){ if (scan.timestamp < cutoff) delete scans[key]; }
  scans[card] = { card_uid: card, event: event, timestamp: now, student_name: studentName || "", class: studentClass || "" };
  try { localStorage.setItem(LOCAL_SCANS_KEY, JSON.stringify(scans)); } catch {}
  localStorage.setItem("juniorclub_scan_notify", JSON.stringify({ card, event, timestamp: now }));
  localStorage.removeItem("juniorclub_scan_notify");
}

function loadTempStudents(){ try{ const raw = localStorage.getItem(TEMP_STORAGE_KEY); if(!raw) return []; const data = JSON.parse(raw), unique = {}; data.forEach(t => unique[t.card_uid] = t); return Object.values(unique); }catch{ return []; } }
function saveTempStudents(arr){ try{ const unique = {}; arr.forEach(t => unique[t.card_uid] = t); localStorage.setItem(TEMP_STORAGE_KEY, JSON.stringify(Object.values(unique))); }catch{} }

function loadOperator(){
  operator = localStorage.getItem(OPERATOR_STORAGE_KEY) || "";
  if(!operator){ operator = prompt("Enter your staff email/name:") || "Unknown Staff"; localStorage.setItem(OPERATOR_STORAGE_KEY, operator); }
  const el = document.getElementById("operatorName"); if(el) el.textContent = operator;
}

async function loadMapping(){
  try{
    const csv = await fetch(MAPPING_CSV_URL, {cache:"no-store"}).then(r => r.text());
    const rows = parseCSV(csv);
    const mapped = rows.filter(r => r.card_uid && r.status === "active" && r.student_name).map(r => ({ card_uid: r.card_uid, student_name: r.student_name.trim(), class: r.class || "", temp: false }));
    const localRegistered = loadLocalRegistered();
    for (const [card, rec] of Object.entries(localRegistered)){
      if (rec.status === "active" && !mapped.find(m => m.card_uid === card)){
        mapped.push({ card_uid: card, student_name: (rec.student_name || "").trim(), class: rec.class || "", temp: false });
      }
    }
    const temps = tempStudents.map(t => ({ card_uid: t.card_uid, student_name: t.student_name, class: t.class, temp: true, note: t.note }));
    students = [...mapped, ...temps];
    students.sort((a,b) => a.student_name.localeCompare(b.student_name));
  }catch(e){ showToast("Failed to load students: " + e.message, true); }
}

async function loadAttendance(){
  try{
    const csv = await fetch(ATT_CSV_URL, {cache:"no-store"}).then(r => r.text());
    const rows = parseCSV(csv), latest = {};
    rows.forEach(r => { if(!r.card_uid || (r.event !== "IN" && r.event !== "OUT")) return; const t = parseEU(r.Timestamp); if(!latest[r.card_uid] || t > latest[r.card_uid].t) latest[r.card_uid] = { event: r.event, t }; });
    const localScans = loadLocalScans();
    for (const [card, scan] of Object.entries(localScans)){
      if (scan.event !== "IN" && scan.event !== "OUT") continue;
      const existing = latest[card];
      if (!existing || scan.timestamp > existing.t){
        latest[card] = { event: scan.event, t: scan.timestamp };
      }
    }
    attendanceState = {}; Object.entries(latest).forEach(([card, data]) => { attendanceState[card] = data.event; });
    // Compute just left
    const now = Date.now();
    justLeftStudents = [];
    Object.entries(latest).forEach(([card, data]) => {
      if(data.event === "OUT" && data.t && (now - data.t) <= JUST_LEFT_MS){
        const student = students.find(s => s.card_uid === card);
        if(student) justLeftStudents.push({ ...student, leftTime: data.t });
      }
    });
    justLeftStudents.sort((a,b) => b.leftTime - a.leftTime);
    clearOldOverrides(); Object.entries(localOverrides).forEach(([card, override]) => { attendanceState[card] = override.state; });
  }catch(e){ showToast("Failed to load attendance: " + e.message, true); }
}

async function reloadData(){
  try{
    await Promise.all([loadMapping(), loadAttendance()]);
    renderTable(); updateStats(); renderJustLeft();
    const el = document.getElementById("lastUpdate"); if(el) el.textContent = new Date().toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
  }catch(e){ showToast("Failed to reload: " + e.message, true); }
}

function manualRefresh(){ reloadData(); showToast("‚úì Refreshed"); }

function postAttendance(card, event, note = ""){
  const d = new URLSearchParams();
  d.append(ATT.card_uid, card); d.append(ATT.event, event); d.append(ATT.device_id, DEVICE_ID); d.append(ATT.method, "MANUAL");
  d.append(ATT.operator, operator); d.append(ATT.note, note); d.append(ATT.club_id, CLUB_ID); d.append(ATT.schema_version, SCHEMA_VERSION);
  fetch(ATT_FORM_URL, {method:"POST", mode:"no-cors", body:d});
  const student = students.find(s => s.card_uid === card);
  recordLocalScan(card, event, student?.student_name || "", student?.class || "");
  attendanceState[card] = event; saveLocalOverride(card, event); renderTable(); updateStats();
}

function toggleStudent(card, currentState, name){
  const newState = currentState === "IN" ? "OUT" : "IN";
  postAttendance(card, newState, `Manual toggle by ${operator}`);
  showToast(`${name} ‚Üí ${newState}`);
}

function markAllOut(){
  if(!confirm("Mark ALL students as OUT?")) return;
  students.forEach(s => { if(attendanceState[s.card_uid] === "IN") postAttendance(s.card_uid, "OUT", "Bulk OUT"); });
  showToast("All marked OUT");
}

function updateStats(){
  let inCount = 0, outCount = 0;
  students.forEach(s => { if(attendanceState[s.card_uid] === "IN") inCount++; else outCount++; });
  document.getElementById("statIn").textContent = inCount;
  document.getElementById("statOut").textContent = outCount;
  document.getElementById("statTotal").textContent = students.length;
}

function renderJustLeft(){
  const card = document.getElementById("justLeftCard");
  const list = document.getElementById("justLeftList");
  clearNode(list);
  if(justLeftStudents.length === 0){ card.style.display = "none"; return; }
  card.style.display = "block";
  justLeftStudents.forEach(s => {
    const chip = document.createElement("div");
    chip.className = "left-chip";
    chip.textContent = s.student_name;
    list.appendChild(chip);
  });
}

function renderTable(){
  const tbody = document.getElementById("studentTable");
  clearNode(tbody);
  const searchVal = (document.getElementById("searchBox").value || "").toLowerCase();
  const classFilterVal = document.getElementById("classFilter").value;
  const filtered = students.filter(s => {
    const matchSearch = !searchVal || s.student_name.toLowerCase().includes(searchVal) || s.class.toLowerCase().includes(searchVal);
    const matchClass = !classFilterVal || s.class === classFilterVal;
    return matchSearch && matchClass;
  });
  if(filtered.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = '<td colspan="4"><div class="empty"><div class="empty-icon">üîç</div><div class="empty-text">No students found</div></div></td>';
    tbody.appendChild(tr); return;
  }
  filtered.forEach(s => {
    const state = attendanceState[s.card_uid] || "OUT";
    const tr = document.createElement("tr"); if(s.temp) tr.classList.add("temp");
    const statusClass = state === "IN" ? "status-in" : "status-out";
    const btnClass = state === "IN" ? "out" : "in";
    const btnText = state === "IN" ? "Check OUT" : "Check IN";
    const removeBtn = s.temp ? `<button class="remove-btn" onclick="removeTempStudent('${s.card_uid}', '${s.student_name}')">Remove</button>` : "";
    tr.innerHTML = `<td>${s.student_name}${s.temp ? ' üè∑Ô∏è' : ''}</td><td>${s.class}</td><td><span class="${statusClass}">${state}</span></td><td><button class="toggle-btn ${btnClass}" onclick="toggleStudent('${s.card_uid}', '${state}', '${s.student_name}')">${btnText}</button>${removeBtn}</td>`;
    tbody.appendChild(tr);
  });
}

function initClassFilter(){
  const sel = document.getElementById("classFilter");
  clearNode(sel);
  const opt0 = document.createElement("option"); opt0.value = ""; opt0.textContent = "All classes"; sel.appendChild(opt0);
  CLASSES.forEach(c => { const opt = document.createElement("option"); opt.value = c; opt.textContent = c; sel.appendChild(opt); });
  const selTemp = document.getElementById("tempClass");
  clearNode(selTemp);
  const opt0t = document.createElement("option"); opt0t.value = ""; opt0t.textContent = "Select class"; selTemp.appendChild(opt0t);
  CLASSES.forEach(c => { const opt = document.createElement("option"); opt.value = c; opt.textContent = c; selTemp.appendChild(opt); });
}

function openAddTempModal(){ document.getElementById("addTempModal").classList.add("show"); document.getElementById("tempName").value = ""; document.getElementById("tempClass").value = ""; document.getElementById("tempNote").value = ""; document.getElementById("tempName").focus(); }
function closeAddTempModal(){ document.getElementById("addTempModal").classList.remove("show"); }

async function submitAddTemp(){
  const name = document.getElementById("tempName").value.trim();
  const cls = document.getElementById("tempClass").value;
  const note = document.getElementById("tempNote").value.trim();
  if(!name){ showToast("Name required", true); return; }
  if(!cls){ showToast("Class required", true); return; }
  const card = generateTempCardUID();
  const temp = { card_uid: card, student_name: name, class: cls, note: note, temp: true };
  tempStudents.push(temp);
  saveTempStudents(tempStudents);
  postAttendance(card, "IN", "Temporary student added");
  closeAddTempModal();
  await loadMapping();
  attendanceState[card] = "IN";
  saveLocalOverride(card, "IN");
  renderTable(); updateStats();
  showToast(`${name} added & checked IN`);
}

function removeTempStudent(card, name){
  if(!confirm(`Remove temporary student "${name}"?`)) return;
  tempStudents = tempStudents.filter(t => t.card_uid !== card);
  saveTempStudents(tempStudents);
  students = students.filter(s => s.card_uid !== card);
  delete attendanceState[card];
  renderTable(); updateStats();
  showToast(`${name} removed`);
}

document.getElementById("searchBox")?.addEventListener("input", renderTable);
document.getElementById("classFilter")?.addEventListener("change", renderTable);

window.addEventListener("storage", (e) => {
  if (e.key === "juniorclub_scan_notify" || e.key === "juniorclub_register_notify"){
    reloadData();
  }
});

async function init(){
  loadOperator();
  tempStudents = loadTempStudents();
  localOverrides = loadLocalOverrides();
  initClassFilter();
  await reloadData();
  setInterval(reloadData, 5000);
}
</script>
</body>
</html>
