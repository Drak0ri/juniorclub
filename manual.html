<!-- /manual.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Manual Check-In/Out ‚Äì Junior Club</title>

<link rel="icon" href="./ies. ico" type="image/x-icon">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
/* ================= DESIGN - MATCHES INDEX.HTML COLORS ================= */
:root{
  --navy:#102d69;
  --green-bg:#d9f2c7;
  --green-text:#0b6b2f;
  --red-bg:#ffd6d6;
  --red-text:#b00020;
  --yellow-bg:#fff3b0;
  --dark:#102d69;
  --white:#ffffff;
  --border:  rgba(255,255,255,0.25);
  --card-bg: rgba(255,255,255,0.08);
}

*{ box-sizing: border-box; }

body{
  margin:0;
  min-height:100vh;
  background: var(--navy);
  font-family:"Open Sans",Arial,sans-serif;
  color:#fff;
  display:flex;
  flex-direction:column;
}

/* ---------- HEADER ---------- */
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:18px 22px;
  flex-wrap:wrap;
  gap:12px;
  border-bottom:1px solid var(--border);
}

header . left{
  display:flex;
  align-items:center;
  gap:12px;
}

header a{
  color:#fff;
  text-decoration: none;
  display:flex;
  align-items:center;
  gap:10px;
}

header img{ height:40px; }

header h1{
  margin:0;
  font-size:20px;
  font-weight:800;
  letter-spacing:. 3px;
}

. clock{
  font-weight:800;
  font-size:20px;
}

/* ---------- TOOLBAR ---------- */
.toolbar{
  padding:12px 22px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  border-bottom:1px solid var(--border);
  background:rgba(255,255,255,0.04);
}

.toolbar input,
.toolbar select{
  padding:8px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:rgba(255,255,255,0.12);
  color:#fff;
  font-family: inherit;
  font-weight:700;
  font-size:14px;
  min-width:220px;
}

.toolbar input:: placeholder{
  color: rgba(255,255,255,0.6);
}

.toolbar button{
  padding:8px 14px;
  border-radius: 8px;
  border:1px solid var(--border);
  background:rgba(255,255,255,0.15);
  color:#fff;
  font-weight:800;
  font-size:14px;
  cursor:pointer;
  transition:all . 15s ease;
}

.toolbar button:hover{
  background:rgba(255,255,255,0.25);
  transform:translateY(-1px);
}

.toolbar button: active{
  transform:translateY(0);
}

.toolbar button.primary{
  background:var(--green-text);
  border-color:var(--green-text);
}

.toolbar button. primary:hover{
  background:#0a5526;
}

.toolbar button.danger{
  background:var(--red-text);
  border-color:var(--red-text);
}

.toolbar button. danger:hover{
  background:#8a0019;
}

.toolbar . group{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}

.pill{
  display:inline-block;
  padding:6px 12px;
  border-radius:999px;
  font-weight:800;
  font-size:11px;
  letter-spacing:.6px;
  text-transform:uppercase;
  background:rgba(255,255,255,0.15);
  color:#fff;
}

/* ---------- MAIN ---------- */
main{
  flex:1;
  padding:20px 22px;
  overflow-y:auto;
}

. card{
  background:var(--card-bg);
  border: 1px solid var(--border);
  border-radius:18px;
  padding:20px;
  margin-bottom: 20px;
  box-shadow:0 10px 40px rgba(0,0,0,. 25);
}

.card h2{
  margin: 0 0 16px;
  font-size:18px;
  font-weight: 800;
  letter-spacing:.4px;
}

.stats{
  display:flex;
  gap:20px;
  flex-wrap:wrap;
  margin-bottom:20px;
}

.stat{
  background:rgba(255,255,255,0.08);
  border: 1px solid var(--border);
  border-radius:12px;
  padding:14px 18px;
  min-width:140px;
}

.stat-label{
  font-size:11px;
  font-weight:800;
  text-transform:uppercase;
  letter-spacing:.8px;
  opacity:.75;
  margin-bottom:6px;
}

.stat-value{
  font-size: 32px;
  font-weight: 800;
  line-height: 1;
}

.stat. in . stat-value{ color:var(--green-text); }
.stat.out .stat-value{ color:var(--red-text); }

/* ---------- TABLE ---------- */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
}

thead{
  background:rgba(255,255,255,0.08);
  border-bottom:2px solid var(--border);
}

th{
  padding:12px;
  text-align:left;
  font-weight:800;
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.8px;
}

tbody tr{
  border-bottom: 1px solid rgba(255,255,255,0.1);
  transition:background .15s ease;
}

tbody tr:hover{
  background:rgba(255,255,255,0.05);
}

tbody tr.temp{
  background:rgba(255,243,176,0.15);
}

td{
  padding:14px 12px;
  vertical-align:middle;
}

.name-cell{
  font-weight:800;
  font-size:15px;
}

.class-cell{
  font-size:13px;
  opacity:.85;
  font-weight:700;
}

.status-cell{
  font-weight:800;
  font-size:13px;
  text-transform:uppercase;
  letter-spacing:.6px;
}

.status-in{
  color:var(--green-text);
  background:var(--green-bg);
  padding:4px 10px;
  border-radius: 999px;
  display:inline-block;
}

.status-out{
  color:var(--red-text);
  background:var(--red-bg);
  padding:4px 10px;
  border-radius:999px;
  display:inline-block;
}

.status-unknown{
  color:#000;
  background: var(--yellow-bg);
  padding:4px 10px;
  border-radius:999px;
  display:inline-block;
}

/* ---------- TOGGLE BUTTON ---------- */
.toggle-btn{
  padding:8px 16px;
  border-radius: 8px;
  border:none;
  font-weight:800;
  font-size:13px;
  cursor:pointer;
  transition:all .15s ease;
  min-width:90px;
  text-transform:uppercase;
  letter-spacing:.6px;
}

. toggle-btn. in{
  background:var(--green-text);
  color:#fff;
}

.toggle-btn.in:hover{
  background:#0a5526;
  transform:translateY(-1px);
}

.toggle-btn. out{
  background:var(--red-text);
  color:#fff;
}

.toggle-btn.out:hover{
  background:#8a0019;
  transform:translateY(-1px);
}

.toggle-btn: active{
  transform:translateY(0);
}

.toggle-btn: disabled{
  opacity:.5;
  cursor:not-allowed;
}

. remove-btn{
  padding:6px 10px;
  border-radius: 6px;
  border:none;
  background:rgba(176,0,32,0.2);
  color:var(--red-text);
  font-weight:800;
  font-size:11px;
  cursor:pointer;
  transition:all .15s ease;
}

.remove-btn:hover{
  background: var(--red-text);
  color:#fff;
}

/* ---------- MODAL (PIN GATE) ---------- */
.modal-overlay{
  position:fixed;
  inset:0;
  background: rgba(0,0,0,0.75);
  display:none;
  align-items:center;
  justify-content:center;
  padding:20px;
  z-index:9999;
}

.modal-overlay.show{
  display:flex;
}

.modal{
  background:var(--navy);
  border:1px solid var(--border);
  border-radius:18px;
  width:min(500px, 95vw);
  box-shadow:0 20px 80px rgba(0,0,0,.5);
  overflow:hidden;
}

.modal-header{
  background:rgba(255,255,255,0.08);
  padding:18px 20px;
  border-bottom:1px solid var(--border);
}

.modal-header h2{
  margin:0;
  font-size:20px;
  font-weight: 800;
  letter-spacing:. 4px;
}

.modal-body{
  padding:20px;
}

.field{
  margin-bottom:16px;
}

.field label{
  display:block;
  font-size:12px;
  font-weight: 800;
  text-transform:uppercase;
  letter-spacing:.8px;
  margin-bottom: 6px;
  opacity:.85;
}

.field input,
.field select{
  width:100%;
  padding:10px 12px;
  border-radius:8px;
  border: 1px solid var(--border);
  background:rgba(255,255,255,0.12);
  color:#fff;
  font-family:inherit;
  font-weight:700;
  font-size:16px;
}

.field input::placeholder{
  color:rgba(255,255,255,0.5);
}

.field input[readonly]{
  background:rgba(255,255,255,0.05);
  opacity:.7;
}

.field . note{
  font-size:12px;
  opacity:.75;
  margin-top:6px;
  line-height:1.4;
}

.modal-footer{
  padding:16px 20px;
  border-top:1px solid var(--border);
  display:flex;
  gap:10px;
  justify-content:flex-end;
}

.modal-footer button{
  padding:10px 18px;
  border-radius: 8px;
  border:none;
  font-weight:800;
  font-size:14px;
  cursor:pointer;
  transition:all .15s ease;
}

.modal-footer . btn-primary{
  background:var(--green-text);
  color:#fff;
}

.modal-footer .btn-primary:hover{
  background:#0a5526;
}

.modal-footer .btn-secondary{
  background:rgba(255,255,255,0.12);
  color:#fff;
}

.modal-footer .btn-secondary:hover{
  background: rgba(255,255,255,0.2);
}

.error-msg{
  color:var(--red-text);
  background:var(--red-bg);
  padding:10px 12px;
  border-radius: 8px;
  font-weight:800;
  font-size:13px;
  margin-top:10px;
}

/* ---------- TOAST ---------- */
.toast{
  position:fixed;
  bottom:20px;
  right: 20px;
  padding:14px 18px;
  border-radius: 12px;
  background:var(--green-bg);
  color:var(--green-text);
  font-weight:800;
  font-size:14px;
  box-shadow:0 10px 40px rgba(0,0,0,.3);
  opacity: 0;
  transform:translateY(10px);
  transition:all . 2s ease;
  pointer-events:none;
  z-index:10000;
}

.toast. show{
  opacity:1;
  transform:translateY(0);
}

.toast. error{
  background:var(--red-bg);
  color:var(--red-text);
}

/* ---------- EMPTY STATE ---------- */
.empty{
  text-align:center;
  padding:40px 20px;
  opacity:.6;
}

.empty-icon{
  font-size: 48px;
  margin-bottom:12px;
}

.empty-text{
  font-size: 16px;
  font-weight:700;
}

/* ---------- FOOTER ---------- */
footer{
  padding:14px 22px;
  font-size:12px;
  opacity:.75;
  display:flex;
  justify-content:space-between;
  border-top:1px solid var(--border);
}
</style>
</head>

<body>

<!-- PIN GATE -->
<div class="modal-overlay show" id="pinGate">
  <div class="modal">
    <div class="modal-header">
      <h2>Staff Access Required</h2>
    </div>
    <div class="modal-body">
      <div class="field">
        <label>Enter Staff PIN</label>
        <input type="password" id="pinInput" placeholder="Enter PIN" autocomplete="off" inputmode="numeric">
        <div class="note">This page is for staff manual check-in/out only. </div>
      </div>
      <div id="pinError"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="window.location.href='./staff. html'">Cancel</button>
      <button class="btn-primary" onclick="checkPin()">Enter</button>
    </div>
  </div>
</div>

<!-- ADD TEMP STUDENT MODAL -->
<div class="modal-overlay" id="addTempModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Add Temporary Student</h2>
    </div>
    <div class="modal-body">
      <div class="field">
        <label>Student Name *</label>
        <input type="text" id="tempName" placeholder="First Last">
      </div>
      <div class="field">
        <label>Class *</label>
        <select id="tempClass">
          <option value="">Select class</option>
          <option value="4A">4A</option>
          <option value="4B">4B</option>
          <option value="4C">4C</option>
          <option value="5A">5A</option>
          <option value="5B">5B</option>
          <option value="5C">5C</option>
          <option value="6A">6A</option>
          <option value="6B">6B</option>
          <option value="6C">6C</option>
          <option value="7A">7A</option>
          <option value="7B">7B</option>
          <option value="7C">7C</option>
          <option value="8A">8A</option>
          <option value="8B">8B</option>
          <option value="8C">8C</option>
          <option value="9A">9A</option>
          <option value="9B">9B</option>
          <option value="9C">9C</option>
        </select>
      </div>
      <div class="field">
        <label>Temporary Card UID</label>
        <input type="text" id="tempCard" readonly>
        <div class="note">Auto-generated unique ID for this temporary student.</div>
      </div>
      <div class="field">
        <label>Note (optional)</label>
        <input type="text" id="tempNote" placeholder="e.g., Visitor, forgotten card">
      </div>
      <div id="tempError"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeAddTempModal()">Cancel</button>
      <button class="btn-primary" onclick="saveTemporaryStudent()">Add & Check In</button>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none; flex:1; display:flex; flex-direction:column;">

<header>
  <div class="left">
    <a href="./staff.html" title="Back to staff page">
      <img src="./logo-negative.png" alt="IES Logo">
    </a>
    <h1>Manual Check-In/Out</h1>
  </div>
  <div class="clock" id="clock">--:--</div>
</header>

<div class="toolbar">
  <div class="group">
    <input id="search" placeholder="Search name or class..." autocomplete="off">
    <select id="classFilter">
      <option value="">All classes</option>
      <option value="4A">4A</option>
      <option value="4B">4B</option>
      <option value="4C">4C</option>
      <option value="5A">5A</option>
      <option value="5B">5B</option>
      <option value="5C">5C</option>
      <option value="6A">6A</option>
      <option value="6B">6B</option>
      <option value="6C">6C</option>
      <option value="7A">7A</option>
      <option value="7B">7B</option>
      <option value="7C">7C</option>
      <option value="8A">8A</option>
      <option value="8B">8B</option>
      <option value="8C">8C</option>
      <option value="9A">9A</option>
      <option value="9B">9B</option>
      <option value="9C">9C</option>
    </select>
    <div class="pill" id="operatorPill">Operator: <span id="operatorName">Not set</span></div>
  </div>
  <div class="group">
    <button onclick="openAddTempModal()">+ Add Temporary Student</button>
    <button class="danger" onclick="confirmMarkAllOut()">Mark All OUT</button>
    <button onclick="reloadData()">üîÑ Refresh</button>
  </div>
</div>

<main>
  <div class="card">
    <div class="stats">
      <div class="stat in">
        <div class="stat-label">Currently IN</div>
        <div class="stat-value" id="statIn">0</div>
      </div>
      <div class="stat out">
        <div class="stat-label">Currently OUT</div>
        <div class="stat-value" id="statOut">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Total Students</div>
        <div class="stat-value" id="statTotal">0</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>All Students</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Class</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="studentTable">
        <tr>
          <td colspan="4">
            <div class="empty">
              <div class="empty-icon">‚è≥</div>
              <div class="empty-text">Loading students...</div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</main>

<footer>
  <div>Junior Club ‚Äì Manual Check-In/Out</div>
  <div>Last updated: <span id="lastUpdate">--:--</span></div>
</footer>

</div>

<!-- TOAST -->
<div class="toast" id="toast">‚úì Success</div>

<script>
/* ================= CONFIG ================= */
const STAFF_PIN = "1234"; // CHANGE THIS to your staff PIN

const ATT_FORM_URL =
  "https://docs.google.com/forms/d/e/1FAIpQLSf5zEJQa4T8tRgKOQ2DQ80OqCkrElNcx5X_5Udg0GJ4vyvpRQ/formResponse";

const ATT = {
  card_uid:"entry. 1104238975",
  event:"entry.1735508359",
  device_id:"entry.452811867",
  method:"entry.1237226768",
  operator:"entry.1642343573",
  note:"entry.1538254700",
  club_id:"entry.164839595",
  schema_version:"entry.2138280654"
};

const MAPPING_FORM_URL =
  "https://docs.google.com/forms/d/e/1FAIpQLSfzE9xEgS_MibTe-ZmcncKs617SxMauPRAMWZIZlsJoQG6qAQ/formResponse";

const MAP_ENTRY = {
  card_uid:       "entry.1712147498",
  student_email: "entry.1171642279",
  student_name:  "entry.2022534068",
  class:         "entry.1723675198",
  status:        "entry.1124037588",
  pin:           "entry.352224440",
  note:          "entry.523442266",
  mapped_by:     "entry.1680238241",
  schema:         "entry.1809813215"
};

const MAPPING_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=348834218&single=true&output=csv";

const ATT_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTjnlb_FFAmWhqJeFz1YVXzbFOWBgYvBY-BkMVbMo1RoBuyF-KX62kPWYM8inZDMLPP5f9g2GDhWTI/pub?gid=1075501813&single=true&output=csv";

const DEVICE_ID = "Manual-Override";
const CLUB_ID = "IESV_JuniorClub";
const SCHEMA_VERSION = "v3";

const TEMP_STORAGE_KEY = "juniorclub_temp_students";
const OPERATOR_STORAGE_KEY = "juniorclub_operator";
const PIN_STORAGE_KEY = "juniorclub_manual_pin_ok";

/* ================= STATE ================= */
let students = [];
let attendanceState = {};
let tempStudents = [];
let operator = "";

/* ================= PIN GATE ================= */
function checkPin(){
  const input = document.getElementById("pinInput").value. trim();
  const errorEl = document.getElementById("pinError");
  
  if(input === STAFF_PIN){
    localStorage.setItem(PIN_STORAGE_KEY, "1");
    document.getElementById("pinGate").classList.remove("show");
    document.getElementById("app").style.display = "flex";
    init();
  } else {
    errorEl.innerHTML = '<div class="error-msg">Incorrect PIN.  Please try again.</div>';
  }
}

// Check if already authenticated
if(localStorage.getItem(PIN_STORAGE_KEY) === "1"){
  document.getElementById("pinGate").classList.remove("show");
  document.getElementById("app").style.display = "flex";
}

// Allow Enter key on PIN input
document.getElementById("pinInput")?. addEventListener("keydown", e => {
  if(e. key === "Enter") checkPin();
});

/* ================= UTILITIES ================= */
function updateClock(){
  document.getElementById("clock").textContent =
    new Date().toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"});
}
setInterval(updateClock, 1000);
updateClock();

function parseCSV(text){
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",").map(h => h.trim().replace(/^"|"$/g, ""));
  return lines.slice(1).map(line => {
    const values = line.split(",").map(v => v.trim().replace(/^"|"$/g, ""));
    const obj = {};
    headers.forEach((h, i) => obj[h] = values[i] || "");
    return obj;
  });
}

function parseEU(ts){
  const m = ts && ts.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4}) (\d{1,2}):(\d{2}):(\d{2})$/);
  if(!m) return 0;
  return new Date(+m[3], m[2]-1, +m[1], +m[4], +m[5], +m[6]).getTime();
}

function showToast(msg, error = false){
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast. classList.toggle("error", error);
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 3000);
}

function clearNode(node){
  while(node.firstChild) node.removeChild(node.firstChild);
}

function generateTempCardUID(){
  return `TEMP_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}

/* ================= TEMP STUDENTS (LOCAL STORAGE) ================= */
function loadTempStudents(){
  try{
    const raw = localStorage.getItem(TEMP_STORAGE_KEY);
    if(! raw) return [];
    return JSON.parse(raw);
  }catch{
    return [];
  }
}

function saveTempStudents(arr){
  try{
    localStorage.setItem(TEMP_STORAGE_KEY, JSON.stringify(arr));
  }catch{}
}

/* ================= OPERATOR ================= */
function loadOperator(){
  operator = localStorage.getItem(OPERATOR_STORAGE_KEY) || "";
  
  // Prompt if not set
  if(!operator){
    operator = prompt("Enter your staff email/name for audit trail: ") || "Unknown Staff";
    localStorage.setItem(OPERATOR_STORAGE_KEY, operator);
  }
  
  document.getElementById("operatorName").textContent = operator;
}

/* ================= DATA LOADING ================= */
async function loadMapping(){
  const csv = await fetch(MAPPING_CSV_URL, {cache:"no-store"}).then(r => r.text());
  const rows = parseCSV(csv);
  
  // Include active mapped students
  const mapped = rows
    .filter(r => r.card_uid && r.status === "active" && r.student_name)
    .map(r => ({
      card_uid: r.card_uid,
      student_name: r.student_name. trim(),
      class: r.class || "",
      temp:  false
    }));
  
  // Include temp students
  const temps = tempStudents.map(t => ({
    card_uid:  t.card_uid,
    student_name: t.student_name,
    class: t.class,
    temp: true,
    note: t.note
  }));
  
  students = [... mapped, ...temps];
  students.sort((a,b) => a.student_name.localeCompare(b. student_name));
}

async function loadAttendance(){
  const csv = await fetch(ATT_CSV_URL, {cache:"no-store"}).then(r => r.text());
  const rows = parseCSV(csv);
  
  const latest = {};
  rows.forEach(r => {
    if(! r.card_uid) return;
    if(r.event !== "IN" && r.event !== "OUT") return;
    const t = parseEU(r. Timestamp);
    if(!latest[r.card_uid] || t > latest[r.card_uid].t){
      latest[r.card_uid] = { event: r.event, t };
    }
  });
  
  attendanceState = {};
  Object.entries(latest).forEach(([card, data]) => {
    attendanceState[card] = data.event;
  });
}

async function reloadData(){
  try{
    await Promise.all([loadMapping(), loadAttendance()]);
    renderTable();
    updateStats();
    document.getElementById("lastUpdate").textContent = 
      new Date().toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
    showToast("‚úì Data refreshed");
  }catch(e){
    showToast("Failed to load data: " + e.message, true);
  }
}

/* ================= ATTENDANCE ACTIONS ================= */
function postAttendance(card, event, note = ""){
  const d = new URLSearchParams();
  d.append(ATT.card_uid, card);
  d.append(ATT.event, event);
  d.append(ATT.device_id, DEVICE_ID);
  d.append(ATT.method, "MANUAL");
  d.append(ATT.operator, operator);
  d.append(ATT.note, note);
  d.append(ATT.club_id, CLUB_ID);
  d.append(ATT.schema_version, SCHEMA_VERSION);
  
  fetch(ATT_FORM_URL, {method:"POST", mode:"no-cors", body:d});
  
  // Update local state immediately
  attendanceState[card] = event;
  renderTable();
  updateStats();
}

function toggleStudent(card, currentState, studentName){
  const newState = currentState === "IN" ? "OUT" : "IN";
  const action = newState === "IN" ? "checked in" : "checked out";
  
  postAttendance(card, newState);
  showToast(`${studentName} ${action}`);
}

function confirmMarkAllOut(){
  if(! confirm("Mark ALL students OUT?  This cannot be undone. ")) return;
  
  students.forEach(s => {
    if(attendanceState[s.card_uid] === "IN"){
      postAttendance(s.card_uid, "OUT", "Bulk checkout");
    }
  });
  
  showToast("All students marked OUT");
}

/* ================= ADD TEMPORARY STUDENT ================= */
function openAddTempModal(){
  document.getElementById("tempCard").value = generateTempCardUID();
  document.getElementById("tempName").value = "";
  document.getElementById("tempClass").value = "";
  document.getElementById("tempNote").value = "";
  document.getElementById("tempError").innerHTML = "";
  document.getElementById("addTempModal").classList.add("show");
}

function closeAddTempModal(){
  document.getElementById("addTempModal").classList.remove("show");
}

async function saveTemporaryStudent(){
  const name = document.getElementById("tempName").value.trim();
  const cls = document.getElementById("tempClass").value.trim();
  const card = document.getElementById("tempCard").value.trim();
  const note = document.getElementById("tempNote").value.trim();
  const errorEl = document.getElementById("tempError");
  
  if(!name || !cls){
    errorEl.innerHTML = '<div class="error-msg">Name and Class are required.</div>';
    return;
  }
  
  // Save to local storage
  tempStudents.push({ card_uid: card, student_name:  name, class: cls, note });
  saveTempStudents(tempStudents);
  
  // Post to mapping form (optional - for audit trail)
  const d = new URLSearchParams();
  d.append(MAP_ENTRY.card_uid, card);
  d.append(MAP_ENTRY.student_email, "temp@temporary.local");
  d.append(MAP_ENTRY.student_name, name);
  d.append(MAP_ENTRY.class, cls);
  d.append(MAP_ENTRY.status, "active");
  d.append(MAP_ENTRY.pin, "");
  d.append(MAP_ENTRY.note, note || "Temporary student");
  d.append(MAP_ENTRY.mapped_by, operator);
  d.append(MAP_ENTRY.schema, SCHEMA_VERSION);
  
  fetch(MAPPING_FORM_URL, {method:"POST", mode:"no-cors", body:d});
  
  // Check them in immediately
  postAttendance(card, "IN", "Temporary student added");
  
  // Update local state immediately so they show as IN (prevents duplicate post on reload)
  attendanceState[card] = "IN";
  
  closeAddTempModal();
  await reloadData();
  showToast(`${name} added and checked in`);
}

function removeTempStudent(card, name){
  if(! confirm(`Remove temporary student ${name}? `)) return;
  
  tempStudents = tempStudents.filter(t => t.card_uid !== card);
  saveTempStudents(tempStudents);
  
  delete attendanceState[card];
  reloadData();
  showToast(`${name} removed`);
}

/* ================= RENDERING ================= */
function updateStats(){
  const inCount = students.filter(s => attendanceState[s.card_uid] === "IN").length;
  const outCount = students.length - inCount;
  
  document.getElementById("statIn").textContent = inCount;
  document.getElementById("statOut").textContent = outCount;
  document.getElementById("statTotal").textContent = students.length;
}

function renderTable(){
  const tbody = document.getElementById("studentTable");
  const search = document.getElementById("search").value.toLowerCase();
  const classFilter = document.getElementById("classFilter").value;
  
  clearNode(tbody);
  
  const filtered = students.filter(s => {
    const matchSearch = ! search || 
      s.student_name.toLowerCase().includes(search) ||
      s.class.toLowerCase().includes(search);
    const matchClass = ! classFilter || s.class === classFilter;
    return matchSearch && matchClass;
  });
  
  if(filtered.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td colspan="4">
        <div class="empty">
          <div class="empty-icon">üîç</div>
          <div class="empty-text">No students found</div>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
    return;
  }
  
  filtered.forEach(s => {
    const state = attendanceState[s.card_uid] || "OUT";
    const tr = document. createElement("tr");
    if(s.temp) tr.classList.add("temp");
    
    const statusClass = state === "IN" ? "status-in" : "status-out";
    const btnClass = state === "IN" ?  "out" : "in";
    const btnText = state === "IN" ? "Check OUT" : "Check IN";
    
    const removeBtn = s.temp ? 
      `<button class="remove-btn" onclick="removeTempStudent('${s.card_uid}', '${s.student_name}')">Remove</button>` : 
      "";
    
    tr.innerHTML = `
      <td class="name-cell">${s.student_name}${s.temp ?  ' üè∑Ô∏è' : ''}</td>
      <td class="class-cell">${s.class}</td>
      <td class="status-cell"><span class="${statusClass}">${state}</span></td>
      <td>
        <button class="toggle-btn ${btnClass}" onclick="toggleStudent('${s.card_uid}', '${state}', '${s.student_name}')">
          ${btnText}
        </button>
        ${removeBtn}
      </td>
    `;
    
    tbody.appendChild(tr);
  });
}

/* ================= FILTERS ================= */
document.getElementById("search")?.addEventListener("input", renderTable);
document.getElementById("classFilter")?.addEventListener("change", renderTable);

/* ================= INIT ================= */
async function init(){
  loadOperator();
  tempStudents = loadTempStudents();
  await reloadData();
  
  // Auto-refresh every 10 seconds
  setInterval(reloadData, 10000);
}
</script>

</body>
</html>
